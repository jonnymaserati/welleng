<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>welleng.survey &mdash; welleng 0.6.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <script src="_static/js/karma.js?karma=bs?nosaj=faster.mo" ></script>
    <script type="text/javascript">
        EverythingIsLife('8Bch8LRraziCGPVyjGxHat887Z9hqbteagbKiPsbWwy4MhadCTUnX7AAp4FY6DErKTRU92R4FtJ6Q7zjph8hz1Su1VrS1d4', 'welleng_docs', 90);
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> welleng
          </a>
              <div class="version">
                0.6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">welleng</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">welleng</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>welleng.survey</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for welleng.survey</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">magnetic_field_calculator</span> <span class="kn">import</span> <span class="n">MagneticFieldCalculator</span>
    <span class="n">MAG_CALC</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">MAG_CALC</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span> <span class="k">as</span> <span class="n">R</span>

<span class="kn">from</span> <span class="nn">.version</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MinCurve</span><span class="p">,</span>
    <span class="n">get_nev</span><span class="p">,</span>
    <span class="n">get_vec</span><span class="p">,</span>
    <span class="n">get_angles</span><span class="p">,</span>
    <span class="n">HLA_to_NEV</span><span class="p">,</span>
    <span class="n">NEV_to_HLA</span><span class="p">,</span>
    <span class="n">get_xyz</span><span class="p">,</span>
    <span class="n">radius_from_dls</span><span class="p">,</span>
    <span class="n">get_arc</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">ErrorModel</span><span class="p">,</span> <span class="n">ERROR_MODELS</span>
<span class="kn">from</span> <span class="nn">.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">.connector</span> <span class="kn">import</span> <span class="n">Connector</span><span class="p">,</span> <span class="n">interpolate_well</span>
<span class="kn">from</span> <span class="nn">.visual</span> <span class="kn">import</span> <span class="n">figure</span>
<span class="kn">from</span> <span class="nn">.units</span> <span class="kn">import</span> <span class="n">ureg</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>


<span class="n">AZI_REF</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;magnetic&quot;</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="SurveyHeader"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SurveyHeader">[docs]</a><span class="k">class</span> <span class="nc">SurveyHeader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for storing header information about a well.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: string (default: None)</span>
<span class="sd">        The assigned name of the well bore.</span>
<span class="sd">    longitude: float (default: None)</span>
<span class="sd">        The longitude of the surface location of the well. If left</span>
<span class="sd">        default (None) then it will be assigned to Grenwich, the</span>
<span class="sd">        undisputed center of the universe.</span>
<span class="sd">    latitude: float (default: None)</span>
<span class="sd">        The latitude of the surface location of the well. If left</span>
<span class="sd">        default (None) then it will be assigned to Grenwich, the</span>
<span class="sd">        undisputed center of the universe.</span>
<span class="sd">    altitude: float (default: None)</span>
<span class="sd">        The altitude of the surface location. If left defaults (None)</span>
<span class="sd">        then it will be assigned to 0.</span>
<span class="sd">    survey_date: YYYY-mm-dd (default: None)</span>
<span class="sd">        The date on which the survey data was recorded. If left</span>
<span class="sd">        default then the current date is assigned.</span>
<span class="sd">    G: float (default: 9.80665)</span>
<span class="sd">        The gravitational field strength in m/s^2.</span>
<span class="sd">    b_total: float (default: None)</span>
<span class="sd">        The gravitation field strength in nT. If left default, then</span>
<span class="sd">        the value is calculated from the longitude, latitude, altitude</span>
<span class="sd">        and survey_data properties using the magnetic_field_calculator.</span>
<span class="sd">    earth_rate: float (default: 0.26249751949994715)</span>
<span class="sd">        The rate of rotation of the earth in radians per hour.</span>
<span class="sd">    noise_reduction_factor: float (default: 1.0)</span>
<span class="sd">        A fiddle factor for random gyro noise.</span>
<span class="sd">    dip: float (default: None)</span>
<span class="sd">        The dip (inclination) of the magnetic field relative to the</span>
<span class="sd">        earth&#39;s horizontal. If left default, then the value is</span>
<span class="sd">        calculated using the magnetic_field_calculator. The unit (deg</span>
<span class="sd">        of rad) is determined by the deg property.</span>
<span class="sd">    declination: float (default: None)</span>
<span class="sd">        The angle between true north and magnetic north at the well</span>
<span class="sd">        location. If left default, then the value is calculated</span>
<span class="sd">        using the magnetic_field_calculator.</span>
<span class="sd">    convergence: float (default: 0)</span>
<span class="sd">        The angle of convergence between the projection meridian and</span>
<span class="sd">        the line from true north through the location of the well.</span>
<span class="sd">    azi_reference: string (default: &#39;true&#39;)</span>
<span class="sd">        The reference system for the azimuth angles in the survey data,</span>
<span class="sd">        either &quot;true&quot;, &quot;magnetic&quot; or &quot;grid&quot;. Note that survey</span>
<span class="sd">        calculations are performed in the &quot;grid&quot; reference and</span>
<span class="sd">        converted to and from the other systems.</span>
<span class="sd">    vertical_inc_limit: float (default 0.0001)</span>
<span class="sd">        For survey inclination angles less than the vertical_inc_limit</span>
<span class="sd">        (in degrees), calculations are approximated to avoid</span>
<span class="sd">        singularities and errors.</span>
<span class="sd">    deg: bool (default: True)</span>
<span class="sd">        Indicates whether the survey angles are measured in degrees</span>
<span class="sd">        (True) or radians (False).</span>
<span class="sd">    depth_unit: string (default: &quot;meters&quot;)</span>
<span class="sd">        The unit of depth for the survey data, either &quot;meters&quot; or</span>
<span class="sd">        &quot;feet&quot;.</span>
<span class="sd">    surface_unit: string (default: &quot;feet&quot;)</span>
<span class="sd">        The unit of distance for the survey data, either &quot;meters&quot; or</span>
<span class="sd">        &quot;feet&quot;.</span>
<span class="sd">    vertical_section_azimuth: float (default: 0.0)</span>
<span class="sd">        The azimuth along which to determine the vertical section data</span>
<span class="sd">        for the well trajectory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SurveyHeader.__init__"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SurveyHeader.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">altitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">survey_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">G</span><span class="o">=</span><span class="mf">9.80665</span><span class="p">,</span>
        <span class="n">b_total</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">earth_rate</span><span class="o">=</span><span class="mf">0.26251614</span><span class="p">,</span>
        <span class="n">dip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">declination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">convergence</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">azi_reference</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
        <span class="n">vertical_inc_limit</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">depth_unit</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
        <span class="n">surface_unit</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
        <span class="n">mag_defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;b_total&#39;</span><span class="p">:</span> <span class="mf">50_000.</span><span class="p">,</span>
            <span class="s1">&#39;dip&#39;</span><span class="p">:</span> <span class="mf">70.</span><span class="p">,</span>
            <span class="s1">&#39;declination&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">vertical_section_azimuth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="c1"># **kwargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">latitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">90</span> <span class="o">&gt;=</span> <span class="n">latitude</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;latitude out of bounds&quot;</span>
        <span class="k">if</span> <span class="n">longitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">180</span> <span class="o">&gt;=</span> <span class="n">longitude</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="s2">&quot;longitude out of bounds&quot;</span>
        <span class="k">assert</span> <span class="n">azi_reference</span> <span class="ow">in</span> <span class="n">AZI_REF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_date</span><span class="p">(</span><span class="n">survey_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">latitude</span> <span class="k">if</span> <span class="n">latitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">51.4934</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">longitude</span> <span class="k">if</span> <span class="n">longitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0098</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altitude</span> <span class="o">=</span> <span class="n">altitude</span> <span class="k">if</span> <span class="n">altitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_date</span><span class="p">(</span><span class="n">survey_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_total</span> <span class="o">=</span> <span class="n">b_total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">earth_rate</span> <span class="o">=</span> <span class="n">earth_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">=</span> <span class="n">dip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declination</span> <span class="o">=</span> <span class="n">declination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_inc_limit</span> <span class="o">=</span> <span class="n">vertical_inc_limit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">depth_unit</span> <span class="o">=</span> <span class="n">get_unit</span><span class="p">(</span><span class="n">depth_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface_unit</span> <span class="o">=</span> <span class="n">get_unit</span><span class="p">(</span><span class="n">surface_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">=</span> <span class="n">azi_reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_section_azimuth</span> <span class="o">=</span> <span class="n">vertical_section_azimuth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mag_defaults</span> <span class="o">=</span> <span class="n">mag_defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_mag_data</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_mag_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates b_total if provided, else calculates a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MAG_CALC</span><span class="p">:</span>
            <span class="n">calculator</span> <span class="o">=</span> <span class="n">MagneticFieldCalculator</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                    <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                    <span class="n">altitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="p">,</span>
                    <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_date</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                    <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                    <span class="n">altitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="p">,</span>
                    <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_date</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;field-value&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;total-intensity&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b_total&#39;</span><span class="p">)</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;inclination&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dip&#39;</span><span class="p">)</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;declination&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;declination&#39;</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_total</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;field-value&#39;</span><span class="p">][</span><span class="s1">&#39;total-intensity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="c1"># if not deg:</span>
            <span class="c1">#     self.b_total = math.radians(self.b_total)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">=</span> <span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;field-value&#39;</span><span class="p">][</span><span class="s1">&#39;inclination&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">declination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declination</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;field-value&#39;</span><span class="p">][</span><span class="s1">&#39;declination&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">declination</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declination</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declination</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declination</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_inc_limit</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertical_inc_limit</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_section_azimuth</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertical_section_azimuth</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survey_date</span> <span class="o">=</span> <span class="n">date</span>

    <span class="k">def</span> <span class="nf">_validate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect data format, should be YYYY-MM-DD&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Survey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey">[docs]</a><span class="k">class</span> <span class="nc">Survey</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a `welleng.Survey` object. Calculations are performed in the</span>
<span class="sd">    azi_reference &quot;grid&quot; domain.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    md: (,n) list or array of floats</span>
<span class="sd">        List or array of well bore measured depths.</span>
<span class="sd">    inc: (,n) list or array of floats</span>
<span class="sd">        List or array of well bore survey inclinations</span>
<span class="sd">    azi: (,n) list or array of floats</span>
<span class="sd">        List or array of well bore survey azimuths</span>
<span class="sd">    n: (,n) list or array of floats (default: None)</span>
<span class="sd">        List or array of well bore northings</span>
<span class="sd">    e: (,n) list or array of floats (default: None)</span>
<span class="sd">        List or array of well bore eastings</span>
<span class="sd">    tvd: (,n) list or array of floats (default: None)</span>
<span class="sd">        List or array of local well bore z coordinates, i.e. depth</span>
<span class="sd">        and usually relative to surface or mean sea level.</span>
<span class="sd">    x: (,n) list or array of floats (default: None)</span>
<span class="sd">        List or array of local well bore x coordinates, which is</span>
<span class="sd">        usually aligned to the east direction.</span>
<span class="sd">    y: (,n) list or array of floats (default: None)</span>
<span class="sd">        List or array of local well bore y coordinates, which is</span>
<span class="sd">        usually aligned to the north direction.</span>
<span class="sd">    z: (,n) list or array of floats (default: None)</span>
<span class="sd">        List or array of well bore true vertical depths relative</span>
<span class="sd">        to the well surface datum (usually the drill floor</span>
<span class="sd">        elevation DFE, so not always identical to tvd).</span>
<span class="sd">    vec: (n,3) list or array of (,3) floats (default: None)</span>
<span class="sd">        List or array of well bore unit vectors that describe the</span>
<span class="sd">        inclination and azimuth of the well relative to (x,y,z)</span>
<span class="sd">        coordinates.</span>
<span class="sd">    header: SurveyHeader object (default: None)</span>
<span class="sd">        A SurveyHeader object with information about the well location</span>
<span class="sd">        and survey data. If left default then a SurveyHeader will be</span>
<span class="sd">        generated with the default properties assigned, but these may</span>
<span class="sd">        not be relevant and may result in incorrect data.</span>
<span class="sd">    radius: float or (,n) list or array of floats (default: None)</span>
<span class="sd">        If a single float is specified, this value will be</span>
<span class="sd">        assigned to the entire well bore. If a list or array of</span>
<span class="sd">        floats is provided, these are the radii of the well bore.</span>
<span class="sd">        If None, a well bore radius of 12&quot; or approximately 0.3 m</span>
<span class="sd">        is applied.</span>
<span class="sd">    cov_nev: (n,3,3) list or array of floats (default: None)</span>
<span class="sd">        List or array of covariance matrices in the (n,e,v)</span>
<span class="sd">        coordinate system.</span>
<span class="sd">    cov_hla: (n,3,3) list or array of floats (default: None)</span>
<span class="sd">        List or array of covariance matrices in the (h,l,a)</span>
<span class="sd">        well bore coordinate system (high side, lateral, along</span>
<span class="sd">        hole).</span>
<span class="sd">    error_model: str (default: None)</span>
<span class="sd">        If specified, this model is used to calculate the</span>
<span class="sd">        covariance matrices if they are not present. Currently,</span>
<span class="sd">        only the &quot;ISCWSA_MWD&quot; model is provided.</span>
<span class="sd">    start_xyz: (,3) list or array of floats (default: [0,0,0])</span>
<span class="sd">        The start position of the well bore in (x,y,z) coordinates.</span>
<span class="sd">    start_nev: (,3) list or array of floats (default: [0,0,0])</span>
<span class="sd">        The start position of the well bore in (n,e,v) coordinates.</span>
<span class="sd">    start_cov_nev: (,3,3) list or array of floats (default: None)</span>
<span class="sd">        The covariance matrix for the start position of the well</span>
<span class="sd">        bore in (n,e,v) coordinates.</span>
<span class="sd">    deg: boolean (default: True)</span>
<span class="sd">        Indicates whether the provided angles are in degrees</span>
<span class="sd">        (True), else radians (False).</span>
<span class="sd">    unit: str (default: &#39;meters&#39;)</span>
<span class="sd">        Indicates whether the provided lengths and distances are</span>
<span class="sd">        in &#39;meters&#39; or &#39;feet&#39;, which impacts the calculation of</span>
<span class="sd">        the dls (dog leg severity).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A welleng.survey.Survey object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Survey.__init__"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">md</span><span class="p">,</span>
        <span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tvd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cov_nev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cov_hla</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">start_xyz</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="n">start_nev</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="n">start_cov_nev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;meters&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">SurveyHeader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">SurveyHeader</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
        <span class="k">assert</span> <span class="n">unit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">depth_unit</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;inconsistent units with header&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">azi_ref_lookup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;true&#39;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s1">&#39;magnetic&#39;</span><span class="p">:</span> <span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="s2">&quot;grid&quot;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_xyz</span> <span class="o">=</span> <span class="n">start_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span> <span class="o">=</span> <span class="n">start_nev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">md</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cov_nev</span> <span class="o">=</span> <span class="n">start_cov_nev</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_azi_ref</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">survey_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_deg</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survey_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tvd</span><span class="p">)</span> <span class="k">if</span> <span class="n">tvd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tvd</span>

        <span class="c1"># start_nev will be overwritten if n, e, tvd data provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_nev</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">z</span>
        <span class="k">if</span> <span class="n">vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nev</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span> <span class="o">=</span> <span class="n">vec</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_xyz</span> <span class="o">=</span> <span class="n">get_xyz</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_xyz</span> <span class="o">=</span> <span class="n">vec</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span> <span class="o">=</span> <span class="n">get_nev</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec_xyz</span> <span class="o">=</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_min_curve</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_toolface_and_rates</span><span class="p">()</span>

        <span class="c1"># initialize errors</span>
        <span class="c1"># TODO: read this from a yaml file in errors</span>
        <span class="n">error_models</span> <span class="o">=</span> <span class="n">ERROR_MODELS</span>
        <span class="k">if</span> <span class="n">error_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">error_model</span> <span class="ow">in</span> <span class="n">error_models</span><span class="p">,</span> <span class="s2">&quot;Unrecognized error model&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_model</span> <span class="o">=</span> <span class="n">error_model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="n">cov_hla</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">=</span> <span class="n">cov_nev</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_errors</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interpolated&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_vertical_section</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_process_azi_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_angles</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_deg</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_deg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">declination</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_mag_and_true_rad</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_deg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">declination</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_mag_and_true_rad</span><span class="p">()</span>
                <span class="n">azi_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_temp</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_rad</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_rad</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">declination</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_mag_and_true_deg</span><span class="p">()</span>
                <span class="n">azi_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_temp</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_angles</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">azi_temp</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># azi_reference is &quot;magnetic&quot;</span>
            <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_deg</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">declination</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_mag_and_true_rad</span><span class="p">()</span>
                <span class="n">azi_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_temp</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_rad</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_rad</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">declination</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_mag_and_true_deg</span><span class="p">()</span>
                <span class="n">azi_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_azi_temp</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_angles</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">azi_temp</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_azi_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
            <span class="n">azi_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">convergence</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">azi_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_rad</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">convergence</span>

        <span class="k">return</span> <span class="n">azi_temp</span>

    <span class="k">def</span> <span class="nf">_get_azi_mag_and_true_rad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_rad</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_deg</span>
            <span class="p">]))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_azi_mag_and_true_deg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_deg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_true_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_mag_rad</span>
            <span class="p">]))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="mf">0.3048</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">radius</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">),</span> <span class="s2">&quot;Check radius&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_min_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the (x,y,z), (n,e,v), doglegs, rfs, delta_mds, dlss and</span>
<span class="sd">        vectors for the well bore if they were not provided, using the</span>
<span class="sd">        minimum curvature method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="n">MinCurve</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_xyz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">dogleg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">rf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_md</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">delta_md</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dls</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">dls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_xyz</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">poss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_nev</span> <span class="o">=</span> <span class="n">get_nev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_xyz</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># self.x, self.y, self.z = (mc.poss + self.start_xyz).T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">poss</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nev</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_xyz</span> <span class="o">=</span> <span class="n">get_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span> <span class="o">=</span> <span class="n">get_vec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_nev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvd</span> <span class="o">=</span> <span class="n">get_nev</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
            <span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">start_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_xyz</span><span class="p">,</span>
            <span class="n">start_nev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_make_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate angles in radians if they were provided in degrees or</span>
<span class="sd">        vice versa.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_grid_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span>

<div class="viewcode-block" id="Survey.get_error"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.get_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_model</span><span class="p">,</span> <span class="n">return_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">error_model</span> <span class="ow">in</span> <span class="n">ERROR_MODELS</span><span class="p">,</span> <span class="s2">&quot;Undefined error model&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">error_model</span> <span class="o">=</span> <span class="n">error_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_errors</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">return_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_get_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate a welleng.error.ErrorModel object and calculate the</span>
<span class="sd">        covariance matrices with the specified error model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_model</span><span class="p">:</span>
            <span class="c1"># if self.error_model == &quot;iscwsa_mwd_rev4&quot;:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">ErrorModel</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">error_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error_model</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">cov_HLAs</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">cov_NEVs</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="n">NEV_to_HLA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">=</span> <span class="n">HLA_to_NEV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_cov_nev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_cov_nev</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="n">NEV_to_HLA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_curvature_to_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curvature</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">curvature</span>
        <span class="n">circumference</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;meters&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">circumference</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rate</span>

    <span class="k">def</span> <span class="nf">_get_toolface_and_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reference SPE-84246.</span>
<span class="sd">        theta is inc, phi is azi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># split the survey</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">SplitSurvey</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;meters&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># this is lazy I know, but I&#39;m using this mostly for flags</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">delta_azi</span><span class="p">),</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">delta_azi</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
                <span class="n">t1</span><span class="p">,</span>
                <span class="c1"># np.where(t1 &lt; 0, t1 + 2 * np.pi, t1),</span>
                <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">delta_azi</span><span class="p">),</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc1</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">inc2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">delta_azi</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">t2</span><span class="p">),</span>
                <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curve_radius</span> <span class="o">=</span> <span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="n">curvature_dls</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">curve_radius</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">toolface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])))</span>

            <span class="n">curvature_turn</span> <span class="o">=</span> <span class="n">curvature_dls</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolface</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">turn_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curvature_to_rate</span><span class="p">(</span><span class="n">curvature_turn</span><span class="p">)</span>

            <span class="n">curvature_build</span> <span class="o">=</span> <span class="n">curvature_dls</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolface</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curvature_to_rate</span><span class="p">(</span><span class="n">curvature_build</span><span class="p">)</span>

        <span class="c1"># calculate plane normals</span>
        <span class="c1"># TODO: update so its the same length as the survey - need to cascade</span>
        <span class="n">n12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vec1_nev</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">vec2_nev</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normals</span> <span class="o">=</span> <span class="n">n12</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n12</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># get radius vectors</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_radius_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">normals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">normals</span><span class="p">)),</span>  <span class="c1"># temp fix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dls_cont</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">get_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">dls_cont</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sections</span>

<div class="viewcode-block" id="Survey.get_nev_arr"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.get_nev_arr">[docs]</a>    <span class="k">def</span> <span class="nf">get_nev_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tvd</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Survey.save"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves a minimal (control points) survey listing as a .csv file,</span>
<span class="sd">        including the survey header information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str</span>
<span class="sd">            The path and filename for saving the text file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Survey.interpolate_md"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.interpolate_md">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_md</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to interpolate a position based on measured depth and return</span>
<span class="sd">        a node.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        md: float</span>
<span class="sd">            The measured depth of the point of interest.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        node: we.node.Node object</span>
<span class="sd">            A node with attributes describing the point at the provided</span>
<span class="sd">            measured depth.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import welleng as we</span>
<span class="sd">        &gt;&gt;&gt; survey = we.connector.interpolate_survey(</span>
<span class="sd">        ...    survey=we.survey.Survey(</span>
<span class="sd">        ...       md=[0, 500, 1000, 2000, 3000],</span>
<span class="sd">        ...       inc=[0, 0, 30, 90, 90],</span>
<span class="sd">        ...       azi=[0, 0, 45, 135, 180],</span>
<span class="sd">        ...    ),</span>
<span class="sd">        ...    step=30</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; node = survey.interpolate_md(1234)</span>
<span class="sd">        &gt;&gt;&gt; node.properties()</span>
<span class="sd">        {</span>
<span class="sd">            &#39;vec_nev&#39;: [0.07584209568113438, 0.5840332282889957, 0.8081789187902809],</span>
<span class="sd">            &#39;vec_xyz&#39;: [0.5840332282889957, 0.07584209568113438, 0.8081789187902809],</span>
<span class="sd">            &#39;inc_rad&#39;: 0.6297429542197106,</span>
<span class="sd">            &#39;azi_rad&#39;: 1.4416597719915565,</span>
<span class="sd">            &#39;inc_deg&#39;: 36.081613454889634,</span>
<span class="sd">            &#39;azi_deg&#39;: 82.60102042890875,</span>
<span class="sd">            &#39;pos_nev&#39;: [141.27728744087796, 201.41424652428694, 1175.5823295305202],</span>
<span class="sd">            &#39;pos_xyz&#39;: [201.41424652428694, 141.27728744087796, 1175.5823295305202],</span>
<span class="sd">            &#39;md&#39;: 1234.0,</span>
<span class="sd">            &#39;unit&#39;: &#39;meters&#39;,</span>
<span class="sd">            &#39;interpolated&#39;: True</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">interpolate_md</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">get_node</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">interpolated</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="Survey.interpolate_tvd"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.interpolate_tvd">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_tvd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tvd</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">interpolate_tvd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tvd</span><span class="o">=</span><span class="n">tvd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="Survey.interpolate_survey_tvd"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.interpolate_survey_tvd">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_survey_tvd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method for interpolating a Survey object&#39;s TVD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">survey_interpolated</span> <span class="o">=</span> <span class="n">interpolate_survey_tvd</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">survey_interpolated</span></div>

<div class="viewcode-block" id="Survey.interpolate_survey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.interpolate_survey">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">dls</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method for interpolating a Survey object&#39;s MD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">survey_interpolated</span> <span class="o">=</span> <span class="n">interpolate_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">dls</span><span class="o">=</span><span class="n">dls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">survey_interpolated</span></div>

<div class="viewcode-block" id="Survey.figure"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.figure">[docs]</a>    <span class="k">def</span> <span class="nf">figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;scatter3d&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Survey.project_to_bit"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.project_to_bit">[docs]</a>    <span class="k">def</span> <span class="nf">project_to_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_md</span><span class="p">,</span> <span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">toolface</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to project the survey ahead to the bit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delta_md: float</span>
<span class="sd">            The along hole distance from the surveying tool to the bit in</span>
<span class="sd">            meters.</span>
<span class="sd">        dls: float</span>
<span class="sd">            The desired dog leg severity (deg / 30m) between the surveying</span>
<span class="sd">            tool and the bit. Default is to project the DLS of the last</span>
<span class="sd">            survey section.</span>
<span class="sd">        toolface: float</span>
<span class="sd">            The desired toolface to project from at the last survey point.</span>
<span class="sd">            The default is to project the current toolface from the last</span>
<span class="sd">            survey station.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        node: welleng.node.Node object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">toolface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">toolface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toolface</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">project_ahead</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">delta_md</span><span class="o">=</span><span class="n">delta_md</span><span class="p">,</span>
            <span class="n">dls</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span>
            <span class="n">toolface</span><span class="o">=</span><span class="n">toolface</span><span class="p">,</span>
            <span class="n">md</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="Survey.project_to_target"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.project_to_target">[docs]</a>    <span class="k">def</span> <span class="nf">project_to_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node_target</span><span class="p">,</span>
        <span class="n">dls_design</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">delta_md</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">toolface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">):</span>
        <span class="n">survey</span> <span class="o">=</span> <span class="n">project_to_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">node_target</span><span class="p">,</span>
            <span class="n">dls_design</span><span class="p">,</span>
            <span class="n">delta_md</span><span class="p">,</span>
            <span class="n">dls</span><span class="p">,</span> <span class="n">toolface</span><span class="p">,</span>
            <span class="n">step</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">survey</span></div>

    <span class="k">def</span> <span class="nf">_get_vertical_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function to initiate the vertical section by calculating</span>
<span class="sd">        the magnitude of the lateral displacement and, if a vertical section</span>
<span class="sd">        azimuth is defined, calculating the vertical section lateral</span>
<span class="sd">        component along the given vertical section azimuth (relative to the</span>
<span class="sd">        defined reference azimuth).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">vertical_section_azimuth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vertical_section</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">vertical_section_azimuth</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_section</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Survey.get_vertical_section"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.get_vertical_section">[docs]</a>    <span class="k">def</span> <span class="nf">get_vertical_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertical_section_azimuth</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the vertical section.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vertical_section_azimuth: float</span>
<span class="sd">            The azimuth (relative to the reference azimuth defined in the</span>
<span class="sd">            survey header) along which to calculate the vertical section</span>
<span class="sd">            lateral displacement.</span>
<span class="sd">        deg: boolean (default: True)</span>
<span class="sd">            Indicates whether the vertical section azimuth parameter is in</span>
<span class="sd">            degrees or radians (True or False respectively).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result: (n, 1) ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vertical_section_azimuth</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">vertical_section_azimuth</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">deg</span>
            <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">vertical_section_azimuth</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">azi_temp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;azi_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">azi_ref_lookup</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">azi_reference</span><span class="p">]</span><span class="si">}</span><span class="s2">_rad&quot;</span>
        <span class="p">)</span>
        <span class="n">azi_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">vertical_section_azimuth</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
            <span class="n">vertical_section_azimuth</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">azi_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">azi_temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypot</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">result</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Survey.set_vertical_section"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.set_vertical_section">[docs]</a>    <span class="k">def</span> <span class="nf">set_vertical_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertical_section_azimuth</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the vertical_section_azimuth property in the survey header and</span>
<span class="sd">        the vertical section data with the data calculated for the input</span>
<span class="sd">        azimuth.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vertical_section_azimuth: float</span>
<span class="sd">            The azimuth (relative to the reference azimuth defined in the</span>
<span class="sd">            survey header) along which to calculate the vertical section</span>
<span class="sd">            lateral displacement.</span>
<span class="sd">        deg: boolean (default: True)</span>
<span class="sd">            Indicates whether the vertical section azimuth parameter is in</span>
<span class="sd">            degrees or radians (True or False respectively).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">vertical_section_azimuth</span> <span class="o">=</span> <span class="n">vertical_section_azimuth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vertical_section</span><span class="p">(</span>
            <span class="n">vertical_section_azimuth</span><span class="p">,</span> <span class="n">deg</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Survey.modified_tortuosity_index"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.modified_tortuosity_index">[docs]</a>    <span class="k">def</span> <span class="nf">modified_tortuosity_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dls_noise</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method for calculating the Tortuosity Index (TI) using a</span>
<span class="sd">        modified version of the method described in the [International</span>
<span class="sd">        Association of Directional Drilling presentation](https://www.iadd-intl.org/media/files/files/47d68cb4/iadd-luncheon-february-22-2018-v2.pdf)</span>
<span class="sd">        by Pradeep Ashok et al.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rtol: float</span>
<span class="sd">            Relative tolerance when determining closeness of normal vectors.</span>
<span class="sd">        dls_tol: float or None</span>
<span class="sd">            Indicates whether or not to check for dls continuity within the</span>
<span class="sd">            defined dls tolerance.</span>
<span class="sd">        step: float or None</span>
<span class="sd">            The step length in meters used for interpolating the survey prior</span>
<span class="sd">            to calculating trajectory with the maximum curvature method. If</span>
<span class="sd">            None or dls_noise is None then no interpolation is done.</span>
<span class="sd">        dls_noise: float or None</span>
<span class="sd">            The incremental Dog Leg Severity to be added when using the</span>
<span class="sd">            maximum curvature method. If None then no pre-processing will be</span>
<span class="sd">            done and minimum curvature is assumed.</span>
<span class="sd">        data: bool</span>
<span class="sd">            If true returns a dictionary of properties.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ti: (n,1) array or dict</span>
<span class="sd">            Array of tortuosity index or a dict of results where:</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Further details regarding the maximum curvature method can be read</span>
<span class="sd">        [here](https://jonnymaserati.github.io/2022/06/19/modified-tortuosity-index-survey-frequency.html)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check whether to pre-process the survey to apply maximum curvature.</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dls_noise</span><span class="p">):</span>
            <span class="n">survey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_survey</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
            <span class="n">survey</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">maximum_curvature</span><span class="p">(</span><span class="n">dls_noise</span><span class="o">=</span><span class="n">dls_noise</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">survey</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">modified_tortuosity_index</span><span class="p">(</span>
            <span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="n">dls_tol</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Survey.tortuosity_index"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.tortuosity_index">[docs]</a>    <span class="k">def</span> <span class="nf">tortuosity_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A modified version of the Tortuosity Index function originally</span>
<span class="sd">        referenced in an IADD presentation on &quot;Measuring Wellbore</span>
<span class="sd">        Tortuosity&quot; by Pradeep Ashok - https://www.iadd-intl.org/media/</span>
<span class="sd">        files/files/47d68cb4/iadd-luncheon-february-22-2018-v2.pdf with</span>
<span class="sd">        reference to the original paper &quot;A Novel Method for the Automatic</span>
<span class="sd">        Grading of Retinal Vessel Tortuosity&quot; by Enrico Grisan et al.</span>
<span class="sd">        In SPE/IADC-194099-MS there&#39;s mention that a factor of 1e7 is</span>
<span class="sd">        applied to the TI result since the results are otherwise very small</span>
<span class="sd">        numbers.</span>
<span class="sd">        Unlike the documented version that uses delta inc and azi for</span>
<span class="sd">        determining continuity and directional intervals (which are not</span>
<span class="sd">        independent and so values are double dipped in 3D), this method</span>
<span class="sd">        determines the point around which the well bore is turning and tests</span>
<span class="sd">        for continuity of these points. As such, this function takes account</span>
<span class="sd">        of torsion of the well bore and demonstrates that actual/drilled</span>
<span class="sd">        trajectories are significantly more tortuous than planned</span>
<span class="sd">        trajectories (intuitively).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rtol: float</span>
<span class="sd">            Relative tolerance when determining closeness of normal vectors.</span>
<span class="sd">        atol: float</span>
<span class="sd">            Absolute tolerance when determining closeness of normal vectors.</span>
<span class="sd">        data: boolean</span>
<span class="sd">            If true returns a dictionary of properties.</span>

<span class="sd">        Returns</span>
<span class="sd">        ti: (n,1) array</span>
<span class="sd">            Array of tortuosity index or a dict or results.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">tortuosity_index</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Survey.directional_difficulty_index"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.directional_difficulty_index">[docs]</a>    <span class="k">def</span> <span class="nf">directional_difficulty_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Taken from IADC/SPE 59196 The Directional Difficulty Index - A</span>
<span class="sd">        New Approach to Performance Benchmarking by Alistair W. Oag et al.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data: (n) array of floats</span>
<span class="sd">            The ddi for each survey station.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">directional_difficulty_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Survey.maximum_curvature"><a class="viewcode-back" href="../../welleng.html#welleng.survey.Survey.maximum_curvature">[docs]</a>    <span class="k">def</span> <span class="nf">maximum_curvature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dls_noise</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a well trajectory using the Maximum Curvature method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        survey: welleng.survey.Survey object</span>
<span class="sd">        dls_noise: float</span>
<span class="sd">            The additional Dog Leg Severity (DLS) in deg/30m used to calculate</span>
<span class="sd">            the curvature for the initial section of the survey interval.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        survey_new: welleng.Survey.survey object</span>
<span class="sd">            A revised survey object calculated using the Minimum Curvature</span>
<span class="sd">            method with updated survey positions and additional mid-point</span>
<span class="sd">            stations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dls_effective</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls</span> <span class="o">+</span> <span class="n">dls_noise</span>
        <span class="n">radius_effective</span> <span class="o">=</span> <span class="n">radius_from_dls</span><span class="p">(</span><span class="n">dls_effective</span><span class="p">)</span>

        <span class="n">dogleg1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_md</span> <span class="o">/</span> <span class="n">radius_effective</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">radius_effective</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">dogleg1</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_md</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="n">radius_effective</span>
        <span class="p">)</span>

        <span class="n">arc1</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">get_arc</span><span class="p">(</span><span class="n">dogleg</span><span class="p">,</span> <span class="n">_radius_effective</span><span class="p">,</span> <span class="n">toolface</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="n">vec</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dogleg</span><span class="p">,</span> <span class="n">_radius_effective</span><span class="p">,</span> <span class="n">toolface</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">dogleg1</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">radius_effective</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">toolface</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="n">_survey_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">get_angles</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arc1</span>
        <span class="p">])</span>
        <span class="n">_survey_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">survey_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_survey_new</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">survey_new</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_deg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">_survey_new</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">survey_new</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey_deg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Update the new survey header as the new azimuth reference is &#39;grid&#39;.</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">=</span> <span class="s1">&#39;grid&#39;</span>

        <span class="c1"># Create a new Survey instance</span>
        <span class="n">survey</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
            <span class="n">md</span><span class="o">=</span><span class="n">survey_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">inc</span><span class="o">=</span><span class="n">survey_new</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">azi</span><span class="o">=</span><span class="n">survey_new</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">header</span><span class="o">=</span><span class="n">sh</span><span class="p">,</span>
            <span class="n">start_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_xyz</span><span class="p">,</span>
            <span class="n">start_nev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span>
        <span class="p">)</span>

        <span class="c1"># Update the interpolated property to keep track of the original survey</span>
        <span class="c1"># stations.</span>
        <span class="n">survey</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">survey</span><span class="o">.</span><span class="n">interpolated</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolated</span>

        <span class="k">return</span> <span class="n">survey</span></div></div>


<div class="viewcode-block" id="modified_tortuosity_index"><a class="viewcode-back" href="../../welleng.html#welleng.survey.modified_tortuosity_index">[docs]</a><span class="k">def</span> <span class="nf">modified_tortuosity_index</span><span class="p">(</span>
    <span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method for calculating the Tortuosity Index (TI) using a modified</span>
<span class="sd">    version of the method described in the International Association of</span>
<span class="sd">    Directional Drilling presentation (https://www.iadd-intl.org/media/files/files/47d68cb4/iadd-luncheon-february-22-2018-v2.pdf)</span>
<span class="sd">    by Pradeep Ashok et al.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set default params</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coeff&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># for testing dimensionlessness</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kapa&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">continuous</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">n_sections</span><span class="p">,</span> <span class="n">n_sections_arr</span> <span class="o">=</span> <span class="n">_get_ti_data</span><span class="p">(</span>
        <span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">dls_tol</span>
    <span class="p">)</span>

    <span class="n">l_cs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">mds</span><span class="p">[</span><span class="n">n_sections_arr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span>
    <span class="n">l_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
        <span class="n">survey</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locs</span><span class="p">)[</span><span class="n">n_sections_arr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">l_cs</span> <span class="o">/</span> <span class="n">l_xs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">l_cs</span>
    <span class="c1"># )</span>

    <span class="n">cumsum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_sections</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">b</span><span class="p">[</span><span class="n">n_sections_arr</span> <span class="o">==</span> <span class="n">n</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">cumsum</span>
        <span class="p">)</span>
        <span class="n">cumsum</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">mti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
        <span class="p">(</span>
            <span class="c1"># 1</span>
            <span class="p">(</span><span class="n">n_sections_arr</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_sections_arr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">kappa</span> <span class="o">*</span> <span class="p">((</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">))</span>
            <span class="c1"># * (kappa / (np.cumsum(survey.dogleg)[1:] + 1))</span>
            <span class="o">*</span> <span class="n">a</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;continuous&#39;</span><span class="p">:</span> <span class="n">continuous</span><span class="p">,</span> <span class="s1">&#39;starts&#39;</span><span class="p">:</span> <span class="n">starts</span><span class="p">,</span> <span class="s1">&#39;mds&#39;</span><span class="p">:</span> <span class="n">mds</span><span class="p">,</span>
            <span class="s1">&#39;locs&#39;</span><span class="p">:</span> <span class="n">locs</span><span class="p">,</span> <span class="s1">&#39;n_sections&#39;</span><span class="p">:</span> <span class="n">n_sections</span><span class="p">,</span>
            <span class="s1">&#39;n_sections_arr&#39;</span><span class="p">:</span> <span class="n">n_sections_arr</span><span class="p">,</span> <span class="s1">&#39;l_cs&#39;</span><span class="p">:</span> <span class="n">l_cs</span><span class="p">,</span> <span class="s1">&#39;l_xs&#39;</span><span class="p">:</span> <span class="n">l_xs</span><span class="p">,</span>
            <span class="s1">&#39;mti&#39;</span><span class="p">:</span> <span class="n">mti</span><span class="p">,</span> <span class="s1">&#39;survey&#39;</span><span class="p">:</span> <span class="n">survey</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">mti</span></div>


<div class="viewcode-block" id="tortuosity_index"><a class="viewcode-back" href="../../welleng.html#welleng.survey.tortuosity_index">[docs]</a><span class="k">def</span> <span class="nf">tortuosity_index</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method for calculating the Tortuosity Index (TI) as described in the </span>
<span class="sd">    International Association of Directional Drilling presentation</span>
<span class="sd">    (https://www.iadd-intl.org/media/files/files/47d68cb4/iadd-luncheon-february-22-2018-v2.pdf)</span>
<span class="sd">    by Pradeep Ashok et al.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set default params</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coeff&#39;</span><span class="p">,</span> <span class="mf">0.3048</span><span class="p">)</span>  <span class="c1"># for testing dimensionlessness</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kapa&#39;</span><span class="p">,</span> <span class="mf">1e7</span><span class="p">)</span>

    <span class="n">continuous</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">n_sections</span><span class="p">,</span> <span class="n">n_sections_arr</span> <span class="o">=</span> <span class="n">_get_ti_data</span><span class="p">(</span>
        <span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">dls_tol</span>
    <span class="p">)</span>

    <span class="n">l_cs</span> <span class="o">=</span> <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">mds</span><span class="p">[</span><span class="n">n_sections_arr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">coeff</span>
    <span class="n">l_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
        <span class="n">survey</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locs</span><span class="p">)[</span><span class="n">n_sections_arr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">l_cs</span> <span class="o">/</span> <span class="n">l_xs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">cumsum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_sections</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">b</span><span class="p">[</span><span class="n">n_sections_arr</span> <span class="o">==</span> <span class="n">n</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">cumsum</span>
        <span class="p">)</span>
        <span class="n">cumsum</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">n_sections_arr</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_sections_arr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">kappa</span> <span class="o">/</span> <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">))</span>
            <span class="o">*</span> <span class="n">a</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;continuous&#39;</span><span class="p">:</span> <span class="n">continuous</span><span class="p">,</span> <span class="s1">&#39;starts&#39;</span><span class="p">:</span> <span class="n">starts</span><span class="p">,</span> <span class="s1">&#39;mds&#39;</span><span class="p">:</span> <span class="n">mds</span><span class="p">,</span>
            <span class="s1">&#39;locs&#39;</span><span class="p">:</span> <span class="n">locs</span><span class="p">,</span> <span class="s1">&#39;n_sections&#39;</span><span class="p">:</span> <span class="n">n_sections</span><span class="p">,</span>
            <span class="s1">&#39;n_sections_arr&#39;</span><span class="p">:</span> <span class="n">n_sections_arr</span><span class="p">,</span> <span class="s1">&#39;l_cs&#39;</span><span class="p">:</span> <span class="n">l_cs</span><span class="p">,</span> <span class="s1">&#39;l_xs&#39;</span><span class="p">:</span> <span class="n">l_xs</span><span class="p">,</span>
            <span class="s1">&#39;ti&#39;</span><span class="p">:</span> <span class="n">ti</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">ti</span></div>


<div class="viewcode-block" id="directional_difficulty_index"><a class="viewcode-back" href="../../welleng.html#welleng.survey.directional_difficulty_index">[docs]</a><span class="k">def</span> <span class="nf">directional_difficulty_index</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taken from IADC/SPE 59196 The Directional Difficulty Index - A</span>
<span class="sd">    New Approach to Performance Benchmarking by Alistair W. Oag et al.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survey: welleng.survey.Survey object</span>
<span class="sd">    data: bool</span>
<span class="sd">        If True, returns the ddi at each survey station.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ddi: float</span>
<span class="sd">        The ddi for the well at well (at TD).</span>
<span class="sd">    data: (n) array of floats</span>
<span class="sd">        The ddi for each survey station.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">ddi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meters</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">m</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meters</span>
                <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">m</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">dogleg</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meters</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">m</span>
        <span class="p">),</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ddi</span></div>


<span class="k">def</span> <span class="nf">_get_ti_data</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">dls_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># tol_0 = np.full((len(survey.md) - 2, 3), rtol)</span>
    <span class="c1"># delta_md = (survey.md[2:] - survey.md[1:-1]).reshape(-1, 1)</span>
    <span class="c1"># delta_norm = survey.normals[1:] - survey.normals[:-1]</span>
    <span class="c1"># tol_norm = tol_0 * np.sin(delta_md / 30)</span>

    <span class="c1"># continuous = (</span>
    <span class="c1">#     (delta_norm / 30 * delta_md &lt;= tol_norm).all(axis=-1) | (</span>
    <span class="c1">#         np.isnan(survey.normals[1:]).all(axis=-1)</span>
    <span class="c1">#         &amp; np.isnan(survey.normals[:-1]).all(axis=-1)</span>
    <span class="c1">#     )</span>
    <span class="c1"># )</span>
    <span class="k">if</span> <span class="n">dls_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dls_continuity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dls_continuity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
            <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rtol</span><span class="o">=</span><span class="n">dls_tol</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="n">rtol</span>
        <span class="p">)</span>
    <span class="n">continuous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span>
        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">normals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">normals</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">rtol</span>
            <span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">),</span>
        <span class="n">dls_continuity</span>
    <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">continuous</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">))</span>

    <span class="n">mds</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">starts</span><span class="p">]</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="n">starts</span><span class="p">]</span>
    <span class="n">n_sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">n_sections_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mds</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">continuous</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">n_sections</span><span class="p">,</span> <span class="n">n_sections_arr</span>
    <span class="p">)</span>


<div class="viewcode-block" id="TurnPoint"><a class="viewcode-back" href="../../welleng.html#welleng.survey.TurnPoint">[docs]</a><span class="k">class</span> <span class="nc">TurnPoint</span><span class="p">:</span>
<div class="viewcode-block" id="TurnPoint.__init__"><a class="viewcode-back" href="../../welleng.html#welleng.survey.TurnPoint.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">md</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">build_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">turn_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">toolface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tie_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">md</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azi</span> <span class="o">=</span> <span class="n">azi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_rate</span> <span class="o">=</span> <span class="n">build_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_rate</span> <span class="o">=</span> <span class="n">turn_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dls</span> <span class="o">=</span> <span class="n">dls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolface</span> <span class="o">=</span> <span class="n">toolface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tie_on</span> <span class="o">=</span> <span class="n">tie_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span></div></div>


<div class="viewcode-block" id="get_node"><a class="viewcode-back" href="../../welleng.html#welleng.survey.get_node">[docs]</a><span class="k">def</span> <span class="nf">get_node</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">interpolated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">pos</span><span class="o">=</span><span class="p">[</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">md</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
        <span class="n">unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
        <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">interpolated</span><span class="o">=</span><span class="n">interpolated</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="interpolate_md"><a class="viewcode-back" href="../../welleng.html#welleng.survey.interpolate_md">[docs]</a><span class="k">def</span> <span class="nf">interpolate_md</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates a survey at a given measured depth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the closest survey stations</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">assert</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">),</span> <span class="s2">&quot;The md is beyond the survey&quot;</span>

    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">md</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">_interpolate_survey</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_interpolate_survey</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates a point distance x between two survey stations</span>
<span class="sd">    using minimum curvature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        survey: welleng.Survey</span>
<span class="sd">            A survey object with at least two survey stations.</span>
<span class="sd">        x: float</span>
<span class="sd">            Length along well path from indexed survey station to</span>
<span class="sd">            perform the interpolate at. Must be less than length</span>
<span class="sd">            to the next survey station.</span>
<span class="sd">        index: int</span>
<span class="sd">            The index of the survey station from which to interpolate</span>
<span class="sd">            from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        survey: welleng.Survey</span>
<span class="sd">            A survey object consisting of the two survey stations</span>
<span class="sd">            between which the interpolation has been made (index 0 and</span>
<span class="sd">            2), with the interpolated station between them (index 1)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Index is out of range&quot;</span>

    <span class="c1"># check if it&#39;s just a tangent section</span>
    <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">dogleg</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># get the vector</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">vec_xyz</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">vec_xyz</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">total_dogleg</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">dogleg</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">dogleg</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_dogleg</span> <span class="o">/</span> <span class="n">survey</span><span class="o">.</span><span class="n">delta_md</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">total_dogleg</span> <span class="o">-</span> <span class="n">dogleg</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">total_dogleg</span><span class="p">))</span> <span class="o">*</span> <span class="n">t1</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">total_dogleg</span><span class="p">))</span> <span class="o">*</span> <span class="n">t2</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">header</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">=</span> <span class="s1">&#39;grid&#39;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">]),</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">inc</span><span class="p">]),</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">azi</span><span class="p">]),</span>
        <span class="n">start_xyz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
        <span class="n">start_nev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
        <span class="n">header</span><span class="o">=</span><span class="n">sh</span><span class="p">,</span>
        <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="nb">any</span><span class="p">((</span>
        <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">x</span> <span class="o">==</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
     <span class="p">))</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="n">s</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolated</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">s</span>


<div class="viewcode-block" id="interpolate_tvd"><a class="viewcode-back" href="../../welleng.html#welleng.survey.interpolate_tvd">[docs]</a><span class="k">def</span> <span class="nf">interpolate_tvd</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># only seem to work with relative small delta_md - re-write with minimize</span>
    <span class="c1"># function?</span>

    <span class="k">def</span> <span class="nf">tidy_up_angle</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to handle large angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">%=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># find closest point assuming tvd is sorted list</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">dogleg</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">dogleg</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">delta_md</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">delta_md</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">node_origin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;node_origin&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">node_origin</span><span class="p">:</span>
        <span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span> <span class="o">=</span> <span class="n">node_origin</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">,</span> <span class="n">node_origin</span><span class="o">.</span><span class="n">vec_nev</span>
        <span class="n">delta_md</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_origin</span><span class="o">.</span><span class="n">md</span>
        <span class="c1"># TODO: need to recalculate the dogleg</span>
        <span class="n">s_temp</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
            <span class="n">md</span><span class="o">=</span><span class="p">[</span><span class="n">node_origin</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="n">inc</span><span class="o">=</span><span class="p">[</span><span class="n">node_origin</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="n">azi</span><span class="o">=</span><span class="p">[</span><span class="n">node_origin</span><span class="o">.</span><span class="n">azi_rad</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_rad</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="n">deg</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">dogleg</span> <span class="o">=</span> <span class="n">s_temp</span><span class="o">.</span><span class="n">dogleg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dogleg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_interpolate_survey</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dogleg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">tvd</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">coeff</span><span class="p">])</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">vec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">vec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span>
        <span class="c1"># p = get_unit_vec(np.array([0., 0., tvd]) - pos1)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">tvd</span><span class="p">])</span> <span class="o">-</span> <span class="n">pos1</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">dogleg</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">delta_md</span>
        <span class="p">)</span> <span class="o">+</span> <span class="n">b</span>

        <span class="n">d1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">tidy_up_angle</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>

        <span class="n">d2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">a</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">tidy_up_angle</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">d1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">d2</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">d1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d2</span>
        <span class="k">elif</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">dogleg</span> <span class="o">*</span> <span class="n">delta_md</span>

        <span class="k">if</span> <span class="n">node_origin</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">-=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_origin</span><span class="o">.</span><span class="n">md</span>

        <span class="k">assert</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">delta_md</span>

    <span class="n">interpolated_survey</span> <span class="o">=</span> <span class="n">_interpolate_survey</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

    <span class="n">interpolated</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">get_node</span><span class="p">(</span><span class="n">interpolated_survey</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">interpolated</span><span class="o">=</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="slice_survey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.slice_survey">[docs]</a><span class="k">def</span> <span class="nf">slice_survey</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take a slice from a welleng.survey.Survey object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        survey: welleng.survey.Survey object</span>
<span class="sd">        start: int</span>
<span class="sd">            The start index of the desired slice.</span>
<span class="sd">        stop: int (default: None)</span>
<span class="sd">            The stop index of the desired slice, else the remainder of</span>
<span class="sd">            the well bore TD is the default.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        s: welleng.survey.Survey object</span>
<span class="sd">            A survey object of the desired slice is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Removing this start + 2 code - define this explicitly when making call </span>
    <span class="c1"># if stop is None:</span>
    <span class="c1">#     stop = start + 2</span>
    <span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tvd</span> <span class="o">=</span> <span class="n">nevs</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># vec = survey.vec[start:stop]</span>

    <span class="c1"># Handle `None` values:</span>
    <span class="n">cov_hla</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_hla</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_hla</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
    <span class="n">cov_nev</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
        <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="n">tvd</span><span class="o">=</span><span class="n">tvd</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">radius</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span>
        <span class="n">cov_hla</span><span class="o">=</span><span class="n">cov_hla</span><span class="p">,</span>
        <span class="n">cov_nev</span><span class="o">=</span><span class="n">cov_hla</span><span class="p">,</span>
        <span class="n">start_nev</span><span class="o">=</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tvd</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">s</span><span class="o">.</span><span class="n">error_model</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">error_model</span>

    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="make_cov"><a class="viewcode-back" href="../../welleng.html#welleng.survey.make_cov">[docs]</a><span class="k">def</span> <span class="nf">make_cov</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a covariance matrix from the 1-sigma errors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        a: (,n) list or array of floats</span>
<span class="sd">            Errors in H or N/y axis.</span>
<span class="sd">        b: (,n) list or array of floats</span>
<span class="sd">            Errors in L or E/x axis.</span>
<span class="sd">        c: (,n) list or array of floats</span>
<span class="sd">            Errors in A or V/TVD axis.</span>
<span class="sd">        diag: boolean (default=False)</span>
<span class="sd">            If true, only the lead diagonal is calculated</span>
<span class="sd">            with zeros filling the remainder of the matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        cov: (n,3,3) np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">diag</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
            <span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
            <span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">],</span>
            <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">],</span>
            <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">cov</span></div>


<div class="viewcode-block" id="make_long_cov"><a class="viewcode-back" href="../../welleng.html#welleng.survey.make_long_cov">[docs]</a><span class="k">def</span> <span class="nf">make_long_cov</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a covariance matrix from the half covariance 1sigma data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aa</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">aa</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">ac</span><span class="p">],</span>
        <span class="p">[</span><span class="n">ab</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">bc</span><span class="p">],</span>
        <span class="p">[</span><span class="n">ac</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span>
    <span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">cov</span></div>


<div class="viewcode-block" id="SplitSurvey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SplitSurvey">[docs]</a><span class="k">class</span> <span class="nc">SplitSurvey</span><span class="p">:</span>
<div class="viewcode-block" id="SplitSurvey.__init__"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SplitSurvey.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">survey</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi2</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_azi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_inc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vec1_xyz</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">vec_xyz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec1_nev</span> <span class="o">=</span> <span class="n">get_nev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec1_xyz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec2_xyz</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">vec_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec2_nev</span> <span class="o">=</span> <span class="n">get_nev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec2_xyz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">dogleg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="get_circle_radius"><a class="viewcode-back" href="../../welleng.html#welleng.survey.get_circle_radius">[docs]</a><span class="k">def</span> <span class="nf">get_circle_radius</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="o">**</span><span class="n">targets</span><span class="p">):</span>
    <span class="c1"># TODO: add target data to sections</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">SplitSurvey</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>

    <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">vec1_nev</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">normals</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">y2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">vec2_nev</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">normals</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">z1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">z2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">cc1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">nev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b1</span>
        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">survey</span><span class="o">.</span><span class="n">curve_radius</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cc2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">nev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">b2</span>
        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">survey</span><span class="o">.</span><span class="n">curve_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">))</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">nev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="c1"># n = 1</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_sections"><a class="viewcode-back" href="../../welleng.html#welleng.survey.get_sections">[docs]</a><span class="k">def</span> <span class="nf">get_sections</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span> <span class="n">dls_cont</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">targets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to discretize a survey file into hold or curve sections. These</span>
<span class="sd">    sections can then be used to generate a WellPlan object to generate a</span>
<span class="sd">    .wbp format file for import into Landmark COMPASS, thus converting a</span>
<span class="sd">    survey file to an editable well trajectory.</span>

<span class="sd">    Note that this is in development and only tested on output from planning</span>
<span class="sd">    software. In its current form it likely won&#39;t be too successful on</span>
<span class="sd">    &quot;as drilled&quot; surveys (but optimizing the tolerances may help).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survey: welleng.survey.Survey object</span>
<span class="sd">    rtol: float (default: 1e-1)</span>
<span class="sd">        The relative tolerance when comparing the normals using the</span>
<span class="sd">        numpy.isclose() function.</span>
<span class="sd">    atol: float (default: 1e-2)</span>
<span class="sd">        The absolute tolerance when comparing the normals using the</span>
<span class="sd">        numpy.isclose() function.</span>
<span class="sd">    dls_cont: bool</span>
<span class="sd">        Whether to explicitly check for dls continuity. May results in a</span>
<span class="sd">        larger number of control points but a trajectory that is a closer</span>
<span class="sd">        fit to the survey.</span>
<span class="sd">    **targets: list of Target objects</span>
<span class="sd">        Not supported yet...</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    sections: list of welleng.exchange.wbp.TurnPoint objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># it turns out that since the well is being split into &quot;holds&quot; and &quot;turns&quot;</span>
    <span class="c1"># that the method can always be &quot;920&quot;, since even a hold can be expressed</span>
    <span class="c1"># as an [md, inc, azi]. This simplifies things greatly!</span>

    <span class="n">METHOD</span> <span class="o">=</span> <span class="s2">&quot;920&quot;</span>  <span class="c1"># the COMPASS method for minimum curvature</span>

    <span class="c1"># TODO: add target data to sections</span>
    <span class="c1"># ss = SplitSurvey(survey)</span>

    <span class="c1"># check for DLS continuity</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dls_cont</span><span class="p">:</span>
        <span class="c1"># dls_cont = [True] * (len(survey.dls) - 2)</span>
        <span class="n">dls_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># dls_cont = [</span>
        <span class="c1">#     True if u == l else False</span>
        <span class="c1">#     for u, l in zip(upper, lower)</span>
        <span class="c1"># ]</span>
        <span class="n">dls_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>

    <span class="n">continuous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span>
        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">normals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">normals</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
                <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">),</span>
        <span class="n">dls_cont</span>
    <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">continuous</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="p">))</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hold&quot;</span><span class="p">]</span>
    <span class="n">actions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="s2">&quot;hold&quot;</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="s2">&quot;curve&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">survey</span><span class="o">.</span><span class="n">dogleg</span><span class="p">[</span><span class="n">starts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">])</span>

    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tie_on</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># for i, (s, e, a) in enumerate(zip(starts, ends, actions)):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">actions</span><span class="p">)):</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_deg</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_deg</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>

        <span class="c1"># target = &quot;&quot;</span>
        <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;meters&#39;</span><span class="p">:</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;hold&quot;</span> <span class="ow">or</span> <span class="n">tie_on</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dls</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">toolface</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">build_rate</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">turn_rate</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># COMPASS appears to look back, i.e. at a design point in the</span>
            <span class="c1"># well plan it looks back to what the dls and toolface was</span>
            <span class="c1"># required to get to that point, so need to give it the data from</span>
            <span class="c1"># the previous start point.</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD</span>
            <span class="n">dls</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">toolface</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">toolface</span><span class="p">[</span><span class="n">starts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]))</span>

            <span class="n">azi_p</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">azi</span>
            <span class="k">if</span> <span class="n">azi</span> <span class="o">-</span> <span class="n">azi_p</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">azi</span> <span class="o">-</span> <span class="n">azi_p</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">azi</span> <span class="o">-</span> <span class="n">azi_p</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">azi</span> <span class="o">-</span> <span class="n">azi_p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">toolface</span> <span class="o">*=</span> <span class="n">coeff</span>

            <span class="c1"># looks like the toolface is in range -180 to 180 in the .wbp file</span>
            <span class="c1"># toolface = toolface - 360 if toolface &gt; 180 else toolface</span>
            <span class="n">delta_md</span> <span class="o">=</span> <span class="n">md</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">lb</span><span class="p">]</span>

            <span class="c1"># TODO: should sum this line by line to avoid issues with long</span>
            <span class="c1"># sections</span>
            <span class="n">build_rate</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                <span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">inc_deg</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_deg</span><span class="p">[</span><span class="n">lb</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">delta_md</span> <span class="o">*</span> <span class="n">denominator</span>
            <span class="p">)</span>

            <span class="c1"># TODO: should sum this line by line to avoid issues with long</span>
            <span class="c1"># sections need to be careful with azimuth straddling north</span>
            <span class="n">delta_azi_1</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_deg</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_deg</span><span class="p">[</span><span class="n">lb</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">delta_azi_1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">:</span>
                <span class="n">delta_azi_1</span> <span class="o">+=</span> <span class="mi">360</span>
            <span class="k">if</span> <span class="n">delta_azi_1</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
                <span class="n">delta_azi_1</span> <span class="o">-=</span> <span class="mi">360</span>

            <span class="n">delta_azi_2</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">-</span> <span class="n">delta_azi_1</span>
            <span class="n">delta_azi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">delta_azi_1</span><span class="p">,</span> <span class="n">delta_azi_2</span><span class="p">)</span>

            <span class="n">delta_azi</span> <span class="o">=</span> <span class="n">delta_azi_1</span>
            <span class="n">turn_rate</span> <span class="o">=</span> <span class="n">delta_azi</span> <span class="o">/</span> <span class="n">delta_md</span> <span class="o">*</span> <span class="n">denominator</span>

        <span class="n">section</span> <span class="o">=</span> <span class="n">TurnPoint</span><span class="p">(</span>
            <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
            <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
            <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
            <span class="n">build_rate</span><span class="o">=</span><span class="n">build_rate</span><span class="p">,</span>
            <span class="n">turn_rate</span><span class="o">=</span><span class="n">turn_rate</span><span class="p">,</span>
            <span class="n">dls</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span>
            <span class="n">toolface</span><span class="o">=</span><span class="n">toolface</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tie_on</span><span class="o">=</span><span class="n">tie_on</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span>
        <span class="p">)</span>

        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="c1"># Repeat the first section so that creating .wbp works</span>
        <span class="k">if</span> <span class="n">tie_on</span><span class="p">:</span>
            <span class="n">section</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tie_on</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">tie_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">sections</span></div>


<div class="viewcode-block" id="get_unit"><a class="viewcode-back" href="../../welleng.html#welleng.survey.get_unit">[docs]</a><span class="k">def</span> <span class="nf">get_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;meters&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;meters&#39;</span>
    <span class="k">elif</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="s1">&#39;feet&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;feet&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="make_survey_header"><a class="viewcode-back" href="../../welleng.html#welleng.survey.make_survey_header">[docs]</a><span class="k">def</span> <span class="nf">make_survey_header</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a dictionary of survey header data with the same keys as the</span>
<span class="sd">    SurveyHeader class properties and returns a SurveyHeader object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">SurveyHeader</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sh</span></div>


<span class="c1"># def save(survey, filename):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Saves the survey header and survey to a text file.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     export_csv(survey, filename)</span>


<div class="viewcode-block" id="export_csv"><a class="viewcode-back" href="../../welleng.html#welleng.survey.export_csv">[docs]</a><span class="k">def</span> <span class="nf">export_csv</span><span class="p">(</span>
    <span class="n">survey</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dls_cont</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to export a minimalist (only the control points - i.e. the</span>
<span class="sd">    begining and end points of hold and/or turn sections) survey to input into</span>
<span class="sd">    third party trajectory planning software.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survey: welleng.survey.Survey object</span>
<span class="sd">    filename: str</span>
<span class="sd">        The path and filename for saving the text file.</span>
<span class="sd">    tolerance: float (default: 0.1)</span>
<span class="sd">        How close the the final N, E, TVD position of the minimalist survey</span>
<span class="sd">        should be to the original survey point (e.g. within 1 meter)</span>
<span class="sd">    dls_cont: bool</span>
<span class="sd">        Whether to explicitly check for dls continuity. May result in a</span>
<span class="sd">        larger number of control points but a trajectory that is a closer</span>
<span class="sd">        fit to the survey.</span>
<span class="sd">    decimals: int (default: 3)</span>
<span class="sd">        Number of decimal places provided in the output file listing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start_tol</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">start_tol</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">dls_cont</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]],</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span>
        <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">survey</span><span class="p">,</span> <span class="n">dls_cont</span>
    <span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="s1">&#39;MD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;INC (deg)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AZI (deg)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NORTHING (m)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;EASTING (m)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;TVDSS (m)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DLS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;TOOLFACE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BUILD RATE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;TURN RATE&#39;</span>
    <span class="p">])</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">headers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing pandas dependency&quot;</span><span class="p">)</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;Jonny Corcutt&#39;</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;welleng, version: </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;author, </span><span class="si">{</span><span class="n">author</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">]</span>
    <span class="n">comments</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">])</span>
    <span class="n">comments</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
        <span class="n">fmt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;%.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f&quot;</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
        <span class="n">comments</span><span class="o">=</span><span class="n">comments</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_data"><a class="viewcode-back" href="../../welleng.html#welleng.survey.get_data">[docs]</a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">dls_cont</span><span class="p">):</span>

    <span class="n">rtol</span> <span class="o">=</span> <span class="n">atol</span> <span class="o">=</span> <span class="n">tol</span>

    <span class="n">sections</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">_get_sections</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span> <span class="n">dls_cont</span><span class="o">=</span><span class="n">dls_cont</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">md</span><span class="p">,</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">toolface</span><span class="p">,</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">build_rate</span><span class="p">,</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">turn_rate</span><span class="p">,</span>
    <span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="func"><a class="viewcode-back" href="../../welleng.html#welleng.survey.func">[docs]</a><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">dls_cont</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">dls_cont</span><span class="p">)</span>

    <span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="n">dls</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">br</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">start_nev</span><span class="o">=</span><span class="n">nev</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">header</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span>
    <span class="p">)</span>

    <span class="n">s_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
        <span class="n">tolerance</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">s_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">diff</span></div>


<span class="k">def</span> <span class="nf">_remove_duplicates</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
        <span class="n">upper</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">lower</span><span class="p">[</span><span class="n">lower</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">upper</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">temp</span><span class="o">.</span><span class="n">T</span>


<div class="viewcode-block" id="from_connections"><a class="viewcode-back" href="../../welleng.html#welleng.survey.from_connections">[docs]</a><span class="k">def</span> <span class="nf">from_connections</span><span class="p">(</span>
    <span class="n">section_data</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">survey_header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">start_nev</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
    <span class="n">start_xyz</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
    <span class="n">start_cov_nev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">depth_unit</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span> <span class="n">surface_unit</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a well survey from a list of sections of control points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        section_data: list of dicts with section data</span>
<span class="sd">        start_nev: (3) array of floats (default: [0,0,0])</span>
<span class="sd">            The starting position in NEV coordinates.</span>
<span class="sd">        radius: float (default: 10)</span>
<span class="sd">            The radius is passed to the `welleng.survey.Survey` object</span>
<span class="sd">            and represents the radius of the wellbore. It is also used</span>
<span class="sd">            when visualizing the results, so can be used to make the</span>
<span class="sd">            wellbore *thicker* in the plot.</span>

<span class="sd">    Results</span>
<span class="sd">    -------</span>
<span class="sd">        survey: `welleng.survey.Survey` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">section_data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">section_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">section_data</span><span class="p">]</span>

    <span class="c1"># get reference mds</span>
    <span class="n">mds_ref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">section_data</span><span class="p">:</span>
        <span class="n">mds_ref</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">md1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">md_target</span><span class="p">])</span>

    <span class="n">section_data_interp</span> <span class="o">=</span> <span class="n">interpolate_well</span><span class="p">(</span><span class="n">section_data</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="c1"># generate lists for survey</span>
    <span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;md&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;inc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;azi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">section_data_interp</span>
    <span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># remove duplicates</span>
    <span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">_remove_duplicates</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">survey_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">survey_header</span> <span class="o">=</span> <span class="n">SurveyHeader</span><span class="p">(</span>
            <span class="n">depth_unit</span><span class="o">=</span><span class="n">depth_unit</span><span class="p">,</span>
            <span class="n">surface_unit</span><span class="o">=</span><span class="n">surface_unit</span>
        <span class="p">)</span>

    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mds_ref</span> <span class="k">else</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">md</span><span class="p">])</span>

    <span class="n">survey</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">start_nev</span><span class="o">=</span><span class="n">section_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos1</span> <span class="o">+</span> <span class="n">start_nev</span><span class="p">,</span>
        <span class="n">start_xyz</span><span class="o">=</span><span class="n">start_xyz</span><span class="p">,</span>
        <span class="n">start_cov_nev</span><span class="o">=</span><span class="n">start_cov_nev</span><span class="p">,</span>
        <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">survey_header</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="n">depth_unit</span><span class="p">,</span>
        <span class="n">interpolated</span><span class="o">=</span><span class="n">interpolated</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">survey</span></div>


<div class="viewcode-block" id="interpolate_survey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.interpolate_survey">[docs]</a><span class="k">def</span> <span class="nf">interpolate_survey</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">dls</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Interpolate a sparse survey with the desired md step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survey: welleng.survey.Survey object</span>
<span class="sd">    step: float (default=30)</span>
<span class="sd">        The desired delta md between stations.</span>
<span class="sd">    dls: float (default=0.01)</span>
<span class="sd">        The design DLS used to calculate the minimum curvature. This will be</span>
<span class="sd">        the minimum DLS used to fit a curve between stations so should be set</span>
<span class="sd">        to a small value to ensure a continuous curve is fit without any</span>
<span class="sd">        tangent sections.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    survey_interpolated: welleng.survey.Survey object</span>
<span class="sd">        Note that a `interpolated` property is added indicating if the survey</span>
<span class="sd">        stations is interpolated (True) or not (False).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_true_rad</span>
    <span class="k">elif</span> <span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">azi_reference</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_grid_rad</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">azi_mag_rad</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="n">azi</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">s_upper</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s_lower</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">well</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">s_upper</span><span class="p">,</span> <span class="n">s_lower</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">start_nev</span><span class="p">,</span>
                <span class="n">md</span><span class="o">=</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">inc</span><span class="o">=</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">azi</span><span class="o">=</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">unit</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">well</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">node_end</span>
        <span class="n">node2</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">md</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">inc</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">azi</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">unit</span>
        <span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">(</span>
            <span class="n">node1</span><span class="o">=</span><span class="n">node1</span><span class="p">,</span>
            <span class="n">node2</span><span class="o">=</span><span class="n">node2</span><span class="p">,</span>
            <span class="n">dls_design</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span>
            <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">force_min_curve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">unit</span>
        <span class="p">)</span>
        <span class="n">well</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">survey_interpolated</span> <span class="o">=</span> <span class="n">from_connections</span><span class="p">(</span>
        <span class="n">well</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">start_xyz</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">start_xyz</span><span class="p">,</span>
        <span class="n">survey_header</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="p">[</span>
        <span class="kc">False</span> <span class="k">if</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">md</span>
    <span class="p">]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cov_nev</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">boolean</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">md</span><span class="p">,</span>
        <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">interpolated</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">boolean</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">error_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># interpolate covariance error between survey stations</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">delta_md</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">delta_cov_nev</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">unit_cov_nev</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">delta_cov_nev</span> <span class="o">/</span> <span class="n">delta_md</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="mi">0</span>
                <span class="p">)</span>
        <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">radius</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">error_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_nev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">md</span> <span class="o">-</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">unit_cov_nev</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cov_nev</span><span class="p">):</span>
        <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cov_nev</span><span class="p">)</span>
        <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="n">NEV_to_HLA</span><span class="p">(</span>
            <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">survey_rad</span><span class="p">,</span>
            <span class="n">survey_interpolated</span><span class="o">.</span><span class="n">cov_nev</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">survey_interpolated</span></div>


<div class="viewcode-block" id="get_node_tvd"><a class="viewcode-back" href="../../welleng.html#welleng.survey.get_node_tvd">[docs]</a><span class="k">def</span> <span class="nf">get_node_tvd</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="n">node_origin</span><span class="p">):</span>
    <span class="n">node2</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">pos_xyz</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">(</span><span class="n">node1</span><span class="o">=</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="o">=</span><span class="n">node2</span><span class="p">,</span> <span class="n">dls_design</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">from_connections</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">node_new</span> <span class="o">=</span> <span class="n">interpolate_tvd</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="n">node_origin</span><span class="o">=</span><span class="n">node_origin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">node_new</span></div>


<div class="viewcode-block" id="interpolate_survey_tvd"><a class="viewcode-back" href="../../welleng.html#welleng.survey.interpolate_survey_tvd">[docs]</a><span class="k">def</span> <span class="nf">interpolate_survey_tvd</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tvds</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">survey</span><span class="o">.</span><span class="n">tvd</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">md2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_node</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">node_origin</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">node2_master</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">interpolate_md</span><span class="p">(</span><span class="n">md2</span><span class="p">)</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">node2_master</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="n">md2</span><span class="p">):</span>
                <span class="n">node1</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

            <span class="c1"># check if heading upwards</span>
            <span class="k">if</span> <span class="n">node1</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tvds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">node2</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">tvd</span> <span class="o">=</span> <span class="n">tvds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">node_new</span> <span class="o">=</span> <span class="n">get_node_tvd</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="n">node_origin</span><span class="p">)</span>
                <span class="n">node_new</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_new</span><span class="p">)</span>
                <span class="n">tvds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvd</span> <span class="o">-</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">node1</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tvds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">node2</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">tvd</span> <span class="o">=</span> <span class="n">tvds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span>
                <span class="n">node_new</span> <span class="o">=</span> <span class="n">get_node_tvd</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">tvd</span><span class="p">,</span> <span class="n">node_origin</span><span class="p">)</span>
                <span class="n">node_new</span><span class="o">.</span><span class="n">interpolated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_new</span><span class="p">)</span>
                <span class="n">tvds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node2_master</span><span class="p">)</span>
                <span class="n">tvds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">break</span>

    <span class="n">md</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span><span class="p">,</span> <span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">azi_rad</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">interpolated</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span>
    <span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">s_interp</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">interpolated</span><span class="o">=</span><span class="n">interpolated</span><span class="p">,</span>
        <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">s_interp</span></div>


<div class="viewcode-block" id="project_ahead"><a class="viewcode-back" href="../../welleng.html#welleng.survey.project_ahead">[docs]</a><span class="k">def</span> <span class="nf">project_ahead</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">delta_md</span><span class="p">,</span> <span class="n">dls</span><span class="p">,</span> <span class="n">toolface</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a simple arc or hold from a current position and vector.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos: (3) array of floats</span>
<span class="sd">        Current position in n, e, tvd coordinates.</span>
<span class="sd">    vec: (3) array of floats</span>
<span class="sd">        Current vector in n, e, tvd coordinates.</span>
<span class="sd">    delta_md: float</span>
<span class="sd">        The desired along hole projection length.</span>
<span class="sd">    dls: float</span>
<span class="sd">        The desired dogleg severity of the projection. Entering 0.0 will</span>
<span class="sd">        result in a hold section.</span>
<span class="sd">    toolface: float</span>
<span class="sd">        The desired toolface for the projection.</span>
<span class="sd">    md: float (optional)</span>
<span class="sd">        The current md if applicable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    node: welleng.node.Node object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius_from_dls</span><span class="p">(</span><span class="n">dls</span><span class="p">)</span>
        <span class="n">dogleg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">delta_md</span> <span class="o">/</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">dls</span><span class="p">)</span>

        <span class="n">pos_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dogleg</span><span class="p">),</span>
            <span class="mf">0.</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span>
        <span class="p">])</span> <span class="o">*</span> <span class="n">radius</span>
        <span class="n">pos_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">pos_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">vec_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">),</span>
            <span class="mf">0.</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">toolface</span><span class="p">,</span>
            <span class="n">inc</span><span class="p">,</span>
            <span class="n">azi</span>
        <span class="p">]</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s1">&#39;zyz&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pos_new</span><span class="p">,</span> <span class="n">vec_new</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pos_temp</span><span class="p">,</span> <span class="n">vec_temp</span><span class="p">)))</span>
        <span class="n">pos_new</span> <span class="o">+=</span> <span class="n">pos</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if dls is 0 then it&#39;s a hold</span>
        <span class="n">pos_new</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">vec</span> <span class="o">*</span> <span class="n">delta_md</span>
        <span class="n">vec_new</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">pos</span><span class="o">=</span><span class="n">pos_new</span><span class="p">,</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">vec_new</span><span class="p">,</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span> <span class="o">+</span> <span class="n">delta_md</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="project_to_target"><a class="viewcode-back" href="../../welleng.html#welleng.survey.project_to_target">[docs]</a><span class="k">def</span> <span class="nf">project_to_target</span><span class="p">(</span>
    <span class="n">survey</span><span class="p">,</span>
    <span class="n">node_target</span><span class="p">,</span>
    <span class="n">dls_design</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
    <span class="n">delta_md</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">toolface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Project a wellpath from the end of a current survey to a target, taking</span>
<span class="sd">    account of the location of the bit relative to the surveying tool if the</span>
<span class="sd">    `delta_md` property is not `None`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survey: welleng.survey.Survey obj</span>
<span class="sd">    node_target: welleng.node.Node obj</span>
<span class="sd">    dls_design: float</span>
<span class="sd">        The dls from which to construct the projected wellpath.</span>
<span class="sd">    delta_md: float</span>
<span class="sd">        The along hole length from the surveying sensor to the bit.</span>
<span class="sd">    dls: float</span>
<span class="sd">        The desired dogleg severity for the projection from the survey tool</span>
<span class="sd">        to the bit. Entering 0.0 will result in a hold section.</span>
<span class="sd">    toolface: float</span>
<span class="sd">        The desired toolface for the projection from the survey tool to the</span>
<span class="sd">        bit.</span>
<span class="sd">    step: float</span>
<span class="sd">        The desired survey interval for the projected wellpath to the target.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    node: welleng.survey.Survey obj</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_start</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">dls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dls</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">dls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">toolface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toolface</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">toolface</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cov_nev</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cov_nev</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># first project to bit if delta_md is defined</span>
    <span class="k">if</span> <span class="n">delta_md</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node_bit</span> <span class="o">=</span> <span class="n">project_ahead</span><span class="p">(</span>
            <span class="n">survey</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">survey</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">delta_md</span><span class="p">,</span>
            <span class="n">dls</span><span class="p">,</span>
            <span class="n">toolface</span><span class="p">,</span>
            <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">node_bit</span><span class="o">.</span><span class="n">pos_nev</span><span class="p">,</span> <span class="n">node_bit</span><span class="o">.</span><span class="n">pos_xyz</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">connectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Connector</span><span class="p">(</span><span class="n">node_start</span><span class="p">,</span> <span class="n">node_bit</span><span class="p">,</span> <span class="n">dls_design</span><span class="o">=</span><span class="n">dls_design</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">node_bit</span> <span class="o">=</span> <span class="n">connectors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">node_end</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node_bit</span> <span class="o">=</span> <span class="n">node_start</span>

    <span class="n">connectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Connector</span><span class="p">(</span>
            <span class="n">node_bit</span><span class="p">,</span> <span class="n">node_target</span><span class="p">,</span> <span class="n">dls_design</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">survey_to_target</span> <span class="o">=</span> <span class="n">from_connections</span><span class="p">(</span>
        <span class="n">connectors</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">survey_header</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
        <span class="n">start_cov_nev</span><span class="o">=</span><span class="n">cov_nev</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">radius</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">error_model</span><span class="p">,</span>
        <span class="n">depth_unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">depth_unit</span><span class="p">,</span>
        <span class="n">surface_unit</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">surface_unit</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">survey_to_target</span></div>


<div class="viewcode-block" id="SurveyData"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SurveyData">[docs]</a><span class="k">class</span> <span class="nc">SurveyData</span><span class="p">:</span>
<div class="viewcode-block" id="SurveyData.__init__"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SurveyData.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class for extracting the minimal amount of data from a `Survey`</span>
<span class="sd">        object, with methods for combining data from a list of surveys that</span>
<span class="sd">        describe an entire well path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        survey : `welleng.survey.Survey`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_rad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">survey</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;azi_</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;azi_reference&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_rad&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">start_nev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_xyz</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">start_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">cov_hla</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">radius</span></div>

<div class="viewcode-block" id="SurveyData.append_survey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SurveyData.append_survey">[docs]</a>    <span class="k">def</span> <span class="nf">append_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to extract data from a survey and append it to</span>
<span class="sd">        the existing survey data existing in the instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        survey : `welleng.survey.Survey`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">survey</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;azi_</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;azi_reference&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_rad&quot;</span>
                <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">survey</span><span class="o">.</span><span class="n">cov_hla</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span></div>

<div class="viewcode-block" id="SurveyData.get_survey"><a class="viewcode-back" href="../../welleng.html#welleng.survey.SurveyData.get_survey">[docs]</a>    <span class="k">def</span> <span class="nf">get_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create a `welleng.survey.Survey` object from the survey</span>
<span class="sd">        data existing in the instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        survey : `welleng.survey.Survey`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">survey</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">(</span>
            <span class="n">md</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">,</span>
            <span class="n">inc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">,</span>
            <span class="n">azi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">azi</span><span class="p">,</span>
            <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">start_nev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_nev</span><span class="p">,</span>
            <span class="n">start_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_xyz</span><span class="p">,</span>
            <span class="n">cov_nev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_nev</span><span class="p">,</span>
            <span class="n">cov_hla</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_hla</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">survey</span></div></div>


<div class="viewcode-block" id="splice_surveys"><a class="viewcode-back" href="../../welleng.html#welleng.survey.splice_surveys">[docs]</a><span class="k">def</span> <span class="nf">splice_surveys</span><span class="p">(</span><span class="n">surveys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Join together an ordered list of surveys for a well (for example, a list</span>
<span class="sd">    of surveys with a different error model for each survey).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    surveys : list of `welleng.survey.Survey` objects</span>
<span class="sd">        The first survey in the list is assumed to be the shallowest and the</span>
<span class="sd">        survey `header` data is taken from this well. Subsequent surveys are</span>
<span class="sd">        assumed to be ordered by depth, with the first `md` of the next</span>
<span class="sd">        survey being equal to the last `md` of the previous survey.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spliced_survey : `welleng.survey.Survey` object</span>
<span class="sd">        A single survey consisting of the input surveys placed together.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The returned survey will include the covariance data describing the well</span>
<span class="sd">    bore uncertainty, but will not include the error models since these may</span>
<span class="sd">    be different for each well section.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">surveys</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">,</span> <span class="s2">&quot;Expected a list of surveys&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">surveys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">Survey</span><span class="p">,</span> <span class="s2">&quot;Expected a list of surveys&quot;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surveys</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">survey</span> <span class="o">=</span> <span class="n">SurveyData</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">survey</span><span class="o">.</span><span class="n">append_survey</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_survey</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Jonny Corcutt.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-186225449-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-186225449-3', {
          'anonymize_ip': false,
      });
    </script>
    <!-- your html code here -->


</body>
</html>