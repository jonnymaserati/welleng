<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>welleng.connector &mdash; welleng 0.6.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <script src="_static/js/karma.js?karma=bs?nosaj=faster.mo" ></script>
    <script type="text/javascript">
        EverythingIsLife('8Bch8LRraziCGPVyjGxHat887Z9hqbteagbKiPsbWwy4MhadCTUnX7AAp4FY6DErKTRU92R4FtJ6Q7zjph8hz1Su1VrS1d4', 'welleng_docs', 90);
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> welleng
          </a>
              <div class="version">
                0.6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">welleng</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">welleng</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>welleng.connector</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for welleng.connector</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
    <span class="n">NUMBA</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">NUMBA</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_vec</span><span class="p">,</span> <span class="n">_get_angles</span><span class="p">,</span> <span class="n">get_angles</span><span class="p">,</span> <span class="n">get_nev</span><span class="p">,</span> <span class="n">get_xyz</span><span class="p">,</span> <span class="n">get_unit_vec</span><span class="p">,</span>
    <span class="n">NEV_to_HLA</span><span class="p">,</span> <span class="n">dls_from_radius</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.node</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">get_node_params</span>


<div class="viewcode-block" id="Connector"><a class="viewcode-back" href="../../welleng.html#welleng.connector.Connector">[docs]</a><span class="k">class</span> <span class="nc">Connector</span><span class="p">:</span>
<div class="viewcode-block" id="Connector.__init__"><a class="viewcode-back" href="../../welleng.html#welleng.connector.Connector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">node2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="n">vec1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inc1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">azi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">md1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">dls_design</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">dls_design2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">md2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vec2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inc2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">azi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
        <span class="n">min_error</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">delta_dls</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">min_tangent</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1_000</span><span class="p">,</span>
        <span class="n">force_min_curve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">closest_approach</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class to provide a fast, efficient method for determining well</span>
<span class="sd">        bore section geometry using the appropriate method based upon the</span>
<span class="sd">        provided parameters, with the intent of assisting machine learning</span>
<span class="sd">        fitness functions. Interpolation between the returned control points</span>
<span class="sd">        can be performed posthumously - attempts are made to keep processing to</span>
<span class="sd">        a minimum in the event that the Connector is being used for machine</span>
<span class="sd">        learning.</span>

<span class="sd">        Only specific combinations of input data are permitted, e.g. if you</span>
<span class="sd">        input both a start vector AND a start inc and azi you&#39;ll get an error</span>
<span class="sd">        (which one is correct after all?). Think about what you&#39;re trying to</span>
<span class="sd">        achieve and provide the data that will facilitate that outcome.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos1: (3) list or array of floats (default: [0,0,0])</span>
<span class="sd">            Start position in NEV coordinates.</span>
<span class="sd">        vec1: (3) list or array of floats or None (default: None)</span>
<span class="sd">            Start position unit vector in NEV coordinates.</span>
<span class="sd">        inc1: float or None (default: None)</span>
<span class="sd">            Start position inclination.</span>
<span class="sd">        azi2: float or None (default: None)</span>
<span class="sd">            Start position azimuth.</span>
<span class="sd">        md1: float or None (default: None)</span>
<span class="sd">            Start position measured depth.</span>
<span class="sd">        dls_design: float (default: 3.0)</span>
<span class="sd">            The desired Dog Leg Severity (DLS) for the (first) curved</span>
<span class="sd">            section in degrees per 30 meters or 100 feet.</span>
<span class="sd">        dls_design2: float or None (default: None)</span>
<span class="sd">            The desired DLS for the second curve section in degrees per</span>
<span class="sd">            30 meters or 100 feet. If set to None then `dls_design` will</span>
<span class="sd">            be the default value.</span>
<span class="sd">        md2: float or None (default: None)</span>
<span class="sd">            The measured depth of the target position.</span>
<span class="sd">        pos2: (3) list or array of floats or None (default: None)</span>
<span class="sd">            The position of the target in NEV coordinates.</span>
<span class="sd">        vec2: (3) list or array of floats or None (default: None)</span>
<span class="sd">            The target unit vector in NEV coordinates.</span>
<span class="sd">        inc1: float or None (default: None)</span>
<span class="sd">            The inclination at the target position.</span>
<span class="sd">        azi2: float or None (default: None)</span>
<span class="sd">            The azimuth at the target position.</span>
<span class="sd">        degrees: boolean (default: True)</span>
<span class="sd">            Indicates whether the input angles (inc, azi) are in degrees</span>
<span class="sd">            (True) or radians (False).</span>
<span class="sd">        unit: string (default: &#39;meters&#39;)</span>
<span class="sd">            Indicates the distance unit, either &#39;meters&#39; or &#39;feet&#39;.</span>
<span class="sd">        min_error: float (default: 1e-5):</span>
<span class="sd">            Infers the error tolerance of the results and is used to set</span>
<span class="sd">            iteration stops when the desired error tolerance is met. Value</span>
<span class="sd">            must be less than 1. Use with caution as the code may</span>
<span class="sd">            become unstable if this value is changed.</span>
<span class="sd">        delta_radius: float (default: 20)</span>
<span class="sd">            The delta radius (first curve and second curve sections) used</span>
<span class="sd">            as an iteration stop when balancing radii. If the resulting</span>
<span class="sd">            delta radius yielded from `dls_design` and `dls_design2` is</span>
<span class="sd">            larger than `delta_radius`, then `delta_radius` defaults to</span>
<span class="sd">            the former.</span>
<span class="sd">        delta_dls: float (default: 0.1)</span>
<span class="sd">            The delta dls (first curve and second curve sections) used as an</span>
<span class="sd">            iteration stop when balancing radii, i.e. if the dls of the second</span>
<span class="sd">            section is within 0.1 deg/30m of the first curve section then the</span>
<span class="sd">            section is considered balanced and no further iterations are</span>
<span class="sd">            performed. Setting this value too low will likely result in hitting</span>
<span class="sd">            the recursion limit.</span>
<span class="sd">        min_tangent: float (default: 10)</span>
<span class="sd">            The minimum tangent length in the `curve_hold_curve` method</span>
<span class="sd">            used to mitigate instability during iterations (where the</span>
<span class="sd">            tangent section approaches or equals 0).</span>
<span class="sd">        max_iterations: int (default: 1000)</span>
<span class="sd">            The maximum number of iterations before giving up trying to</span>
<span class="sd">            fit a `curve_hold_curve`. This number is limited by Python&#39;s</span>
<span class="sd">            depth of recursion, but if you&#39;re hitting the default stop</span>
<span class="sd">            then consider changing `delta_radius` and `min_tangent` as</span>
<span class="sd">            your expectations may be unrealistic (this is open source</span>
<span class="sd">            software after all!)</span>

<span class="sd">        Results</span>
<span class="sd">        -------</span>
<span class="sd">        connector: welleng.connector.Connector object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">md1</span> <span class="o">=</span> <span class="n">get_node_params</span><span class="p">(</span>
                <span class="n">node1</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">node2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos2</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">md2</span> <span class="o">=</span> <span class="n">get_node_params</span><span class="p">(</span>
                <span class="n">node2</span>
            <span class="p">)</span>

        <span class="c1"># Set up a lookup dictionary to use with the logic to determine</span>
        <span class="c1"># what connector method to deploy. Use a binary string to</span>
        <span class="c1"># represent the inputs in the order:</span>
        <span class="c1"># (md2, inc2, azi2, pos2, vec2)</span>
        <span class="c1"># Initially I used boolean logic, but it quickly became non-</span>
        <span class="c1"># transparent and difficult to debug.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_methods</span><span class="p">()</span>

        <span class="c1"># METHODS = [</span>
        <span class="c1">#     &#39;hold&#39;,</span>
        <span class="c1">#     &#39;curve_hold&#39;,</span>
        <span class="c1">#     &#39;min_dist_to_target&#39;,</span>
        <span class="c1">#     &#39;min_curve_to_target&#39;,</span>
        <span class="c1">#     &#39;curve_hold_curve&#39;,</span>
        <span class="c1">#     &#39;min_curve&#39;</span>
        <span class="c1"># ]</span>

        <span class="c1"># quick check that inputs are workable and if not some steer to</span>
        <span class="c1"># the user.</span>
        <span class="k">assert</span> <span class="n">vec1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">inc1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">azi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Require either vec1 or (inc1 and azi1)&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">vec1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">inc1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">azi1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Either vec1 or (inc1 and azi1)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inc1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">azi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">vec1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Either vec1 or (inc1 and azi1)&quot;</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">md2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">pos2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">vec2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">inc2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">azi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Missing target parameters&quot;</span>

        <span class="k">if</span> <span class="n">vec2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inc2</span> <span class="ow">or</span> <span class="n">azi2</span><span class="p">),</span> <span class="s2">&quot;Either vec2 or (inc2 and azi2)&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inc2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">azi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">vec2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Either vec2 or (inc2 and azi2)&quot;</span>
        <span class="k">if</span> <span class="n">md2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">pos2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Either md2 or pos2&quot;</span>
            <span class="k">assert</span> <span class="n">md2</span> <span class="o">&gt;=</span> <span class="n">md1</span><span class="p">,</span> <span class="s2">&quot;md2 must be larger than md1&quot;</span>

        <span class="k">if</span> <span class="n">dls_design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dls_design</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">dls_design</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;dls_design must be greater than zero&quot;</span>
        <span class="k">assert</span> <span class="n">min_error</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;min_error must be less than 1.0&quot;</span>

        <span class="c1"># figure out what method is required to connect the points</span>
        <span class="n">target_input</span> <span class="o">=</span> <span class="n">convert_target_input_to_booleans</span><span class="p">(</span>
            <span class="n">md2</span><span class="p">,</span> <span class="n">inc2</span><span class="p">,</span> <span class="n">azi2</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">vec2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_min_curve</span> <span class="o">=</span> <span class="n">force_min_curve</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_min_curve</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span> <span class="o">=</span> <span class="s1">&#39;min_curve_or_hold&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_methods</span><span class="p">[</span><span class="n">target_input</span><span class="p">]</span>

        <span class="c1"># do some more initialization stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span> <span class="o">=</span> <span class="n">min_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_tangent</span> <span class="o">=</span> <span class="n">min_tangent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg2_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># fill in the input data gaps</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inc1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">azi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">inc1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">azi1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span> <span class="o">=</span> <span class="n">inc1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span> <span class="o">=</span> <span class="n">azi1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_vec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">md1</span> <span class="o">=</span> <span class="n">md1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">pos2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="n">md2</span>

        <span class="k">if</span> <span class="n">vec2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
                <span class="n">nev</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">inc2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">azi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">inc2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">azi2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span> <span class="o">=</span> <span class="n">inc2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">azi2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">get_vec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inc2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">azi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">inc2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span>
            <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">azi2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">azi2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">get_vec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">azi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span>
            <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">inc2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span> <span class="o">=</span> <span class="n">inc2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">get_vec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">vec2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span> <span class="o">=</span> <span class="n">inc2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">azi2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;meters&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">denom</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">denom</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dls_design</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dls_design</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dls_design2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dls_design2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dls_design2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dls_design</span> <span class="o">=</span> <span class="n">dls_design</span>
            <span class="k">if</span> <span class="n">dls_design2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dls_design2</span> <span class="o">=</span> <span class="n">dls_design2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dls_design2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dls_design2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls_design</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denom</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls_design</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_design2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denom</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls_design2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta_dls</span> <span class="o">=</span> <span class="n">delta_dls</span>

        <span class="c1"># some more initialization stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">md3</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closest_approach</span> <span class="o">=</span> <span class="n">closest_approach</span>

        <span class="c1"># Things fall apart if the start and end vectors exactly equal</span>
        <span class="c1"># one another, so need to check for this and if this is the</span>
        <span class="c1"># case, modify the end vector slightly. This is a lazy way of</span>
        <span class="c1"># doing this, but it&#39;s fast. Probably a more precise way would</span>
        <span class="c1"># be to split the dogleg in two, but that&#39;s more hassle than</span>
        <span class="c1"># it&#39;s worth.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">mod_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span><span class="p">)</span>

        <span class="c1"># properly figure out the method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_method</span><span class="p">()</span>

        <span class="c1"># and finally, actually do something...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_method</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_start</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">md</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_end</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">md</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_target</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_min_dist_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">min_dist_to_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">check_dogleg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">get_vec_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_angles_target</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_md_target</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span>

    <span class="k">def</span> <span class="nf">_min_curve_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">min_curve_to_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">check_dogleg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">=</span> <span class="n">get_vec_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_angles_target</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_md_target</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_use_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;hold&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hold</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;min_curve&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_min_curve</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;curve_hold_curve&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos2_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos3_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec23</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_radius_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># self._target_pos_and_vec_defined(deepcopy(self.pos_target))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_pos_and_vec_defined</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distances</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span> <span class="o">&lt;=</span> <span class="n">get_radius_critical</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;min_dist_to_target&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_min_dist_to_target</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closest_approach</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;min_curve_to_target&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_closest_approach</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;min_curve_to_target&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_min_curve_to_target</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;no_input&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;md_and_pos&#39;</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span> <span class="o">==</span> <span class="s1">&#39;hold&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;hold&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_or_hold&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;hold&#39;</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">)</span>
                        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;hold&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_method</span>

    <span class="k">def</span> <span class="nf">_get_initial_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: probably better to load this in from a yaml file</span>
        <span class="c1"># [md2, inc2, azi2, pos2, vec2] forms the booleans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;00000&#39;</span><span class="p">:</span> <span class="s1">&#39;no_input&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00001&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00010&#39;</span><span class="p">:</span> <span class="s1">&#39;curve_hold_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00011&#39;</span><span class="p">:</span> <span class="s1">&#39;curve_hold_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00100&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00101&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00110&#39;</span><span class="p">:</span> <span class="s1">&#39;curve_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;00111&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01000&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01001&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01010&#39;</span><span class="p">:</span> <span class="s1">&#39;curve_hold_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01011&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01100&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01101&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01110&#39;</span><span class="p">:</span> <span class="s1">&#39;curve_hold_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;01111&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10000&#39;</span><span class="p">:</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10001&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10010&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10011&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10100&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10101&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10110&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10111&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11000&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11001&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11010&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11011&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11100&#39;</span><span class="p">:</span> <span class="s1">&#39;min_curve_or_hold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11101&#39;</span><span class="p">:</span> <span class="s1">&#39;vec_and_inc_azi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11110&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11111&#39;</span><span class="p">:</span> <span class="s1">&#39;md_and_pos&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_closest_approach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vec_pos1_pos_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span>
        <span class="n">vec_pos1_pos_target</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec_pos1_pos_target</span><span class="p">)</span>

        <span class="n">cross_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vec_pos1_pos_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">)</span>
        <span class="n">cross_product</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cross_product</span><span class="p">)</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">cross_product</span> <span class="o">/</span> <span class="n">vec_pos1_pos_target</span>
        <span class="n">factor</span> <span class="o">/=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>

        <span class="n">cc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span> <span class="o">+</span> <span class="n">cross_product</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span>
        <span class="p">)</span>

        <span class="n">cc_pos_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="n">cc</span>
        <span class="n">cc_pos_target</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cc_pos_target</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos_target_original</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">+</span> <span class="n">cc_pos_target</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span>

        <span class="c1"># recalculate self.distances with new self.pos_target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distances</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_min_curve_to_target</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_min_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">get_dogleg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">check_dogleg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
                <span class="p">),</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">md1</span>
                    <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
                <span class="p">)</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inc2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec2</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
                        <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos2</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos2</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">md2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">_get_angles_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azi_target</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_md_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_pos2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">pos_target</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distances</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">pos_target</span><span class="p">)</span>

        <span class="n">radius_temp</span> <span class="o">=</span> <span class="n">get_radius_critical</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span>
            <span class="n">distances</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">radius_temp</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">radius_temp</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="p">(</span>
            <span class="n">tangent_length</span><span class="p">,</span>
            <span class="n">dogleg</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">min_dist_to_target</span><span class="p">(</span>
            <span class="n">radius_temp</span><span class="p">,</span>
            <span class="n">distances</span>
        <span class="p">)</span>

        <span class="n">dogleg</span> <span class="o">=</span> <span class="n">check_dogleg</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span>

        <span class="n">dist_curve</span><span class="p">,</span> <span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
                    <span class="n">radius_temp</span><span class="p">,</span>
                    <span class="n">dogleg</span>
                <span class="p">)</span>
        <span class="n">vec3</span> <span class="o">=</span> <span class="n">get_vec_target</span><span class="p">(</span>
            <span class="n">pos1</span><span class="p">,</span>
            <span class="n">vec1</span><span class="p">,</span>
            <span class="n">pos_target</span><span class="p">,</span>
            <span class="n">tangent_length</span><span class="p">,</span>
            <span class="n">dist_curve</span><span class="p">,</span>
            <span class="n">func_dogleg</span>
        <span class="p">)</span>

        <span class="n">tangent_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tangent_temp</span><span class="p">(</span><span class="n">tangent_length</span><span class="p">)</span>

        <span class="n">pos2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pos_target</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">tangent_temp</span> <span class="o">*</span> <span class="n">vec3</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pos2</span>

    <span class="k">def</span> <span class="nf">_target_pos_and_vec_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos3</span><span class="p">,</span> <span class="n">vec_old</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for fitting a curve, hold, curve path between a pair of</span>
<span class="sd">        points with vectors.</span>

<span class="sd">        It&#39;s written in this odd way to allow a solver function like scipy&#39;s</span>
<span class="sd">        optimize to solve it, but so far I&#39;ve not had much success using</span>
<span class="sd">        these.</span>

<span class="sd">        If the curve sections can&#39;t be achieved with the design DLS values,</span>
<span class="sd">        this function will iterate until the two curve section DLSs are</span>
<span class="sd">        approximately balances (in DLS terms) within the prescribed delta_dls</span>
<span class="sd">        parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="n">minimize_target_pos_and_vec_defined</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span>
                <span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">radius_design2</span>
                <span class="p">],)</span>
                <span class="o">+</span> <span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="kc">True</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design2</span>
        <span class="p">)):</span>
            <span class="k">while</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span><span class="p">)</span>
                    <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dogleg2</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos3</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vec23</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">minimize_target_pos_and_vec_defined</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">(</span>
                        <span class="p">([</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">radius_design2</span>
                        <span class="p">],)</span>
                        <span class="o">+</span> <span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="kc">True</span><span class="p">,)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dls</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls2</span>
                <span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_dls</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_happy_finish</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_happy_finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_happy_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get pos1 to pos2 curve data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dogleg</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vec3</span> <span class="o">=</span> <span class="n">get_vec_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos3</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos2</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg2</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_critical2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_design2</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dogleg2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos3</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vec3</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_curve2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_dogleg2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">tangent_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">md3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md2</span> <span class="o">+</span> <span class="n">tangent_length</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md3</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_curve2</span><span class="p">)</span>

<div class="viewcode-block" id="Connector.interpolate"><a class="viewcode-back" href="../../welleng.html#welleng.connector.Connector.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">interpolate_well</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_tangent_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tangent_length</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tangent_length</span><span class="p">):</span>
            <span class="n">tangent_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tangent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tangent_temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tangent_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tangent</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tangent_temp</span>

    <span class="k">def</span> <span class="nf">_mod_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">pos_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># * self.delta_radius</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="n">pos_rand</span>

    <span class="k">def</span> <span class="nf">_get_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">pos_target</span><span class="p">):</span>
        <span class="c1"># When initializing a `curve_hold_curve` and pos_target is directly</span>
        <span class="c1"># ahead it can cause issues (it&#39;s a hold and not a curve). So this code</span>
        <span class="c1"># checks for that condition and if it&#39;s the case, will move the</span>
        <span class="c1"># target_pos a sufficient amount to prevent issues.</span>
        <span class="n">vec_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_target</span> <span class="o">-</span> <span class="n">pos1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">vec_temp</span> <span class="o">=</span> <span class="n">vec_temp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec_temp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec_temp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mod_pos</span><span class="p">(</span><span class="n">pos_target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos_target</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist_to_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">pos_target</span> <span class="o">-</span> <span class="n">pos1</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="n">dist_perp_to_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">pos_target</span> <span class="o">-</span> <span class="n">pos1</span><span class="p">),</span> <span class="n">vec1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dist_perp_to_target</span> <span class="o">&gt;</span> <span class="n">dist_to_target</span><span class="p">:</span>
                <span class="c1"># since a tolerance is being used, occasionally things can go</span>
                <span class="c1"># wrong and need to be caught.</span>
                <span class="n">dist_perp_to_target</span> <span class="o">=</span> <span class="n">dist_to_target</span>

            <span class="n">dist_norm_to_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">dist_to_target</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">-</span> <span class="n">dist_perp_to_target</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="n">dist_to_target</span><span class="p">,</span>
                <span class="n">dist_perp_to_target</span><span class="p">,</span>
                <span class="n">dist_norm_to_target</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="minimize_target_pos_and_vec_defined"><a class="viewcode-back" href="../../welleng.html#welleng.connector.minimize_target_pos_and_vec_defined">[docs]</a><span class="k">def</span> <span class="nf">minimize_target_pos_and_vec_defined</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">pos3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vec_old</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">result</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="n">radius1</span><span class="p">,</span> <span class="n">radius2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">pos3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pos2_init</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_get_pos2</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span> <span class="n">radius1</span><span class="p">)</span>
        <span class="n">pos3_init</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_get_pos2</span><span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span> <span class="n">radius2</span>
        <span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos3</span> <span class="o">=</span> <span class="n">pos2_init</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">pos3_init</span> <span class="o">-</span> <span class="n">pos2_init</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">c</span><span class="o">.</span><span class="n">distances1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_get_distances</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">pos3</span><span class="p">)</span>

    <span class="n">radius_temp1</span> <span class="o">=</span> <span class="n">get_radius_critical</span><span class="p">(</span>
        <span class="n">radius1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">distances1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">min_error</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">radius_temp1</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">=</span> <span class="n">radius_temp1</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="n">radius_effective1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radius1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">)</span>

    <span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dogleg</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">min_dist_to_target</span><span class="p">(</span>
        <span class="n">radius_effective1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">distances1</span>
    <span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">dogleg</span> <span class="o">=</span> <span class="n">check_dogleg</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dogleg</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
                <span class="n">radius_effective1</span><span class="p">,</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dogleg</span>
            <span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vec3</span> <span class="o">=</span> <span class="n">get_vec_target</span><span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos3</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">func_dogleg</span>
    <span class="p">)</span>

    <span class="n">tangent_temp1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_get_tangent_temp</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tangent_length</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">pos2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos3</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">tangent_temp1</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">vec3</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">distances2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_get_distances</span><span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos2</span>
    <span class="p">)</span>

    <span class="n">radius_temp2</span> <span class="o">=</span> <span class="n">get_radius_critical</span><span class="p">(</span>
        <span class="n">radius2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">distances2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">min_error</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">radius_temp2</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical2</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">radius_critical2</span> <span class="o">=</span> <span class="n">radius_temp2</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical2</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="n">radius_effective2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radius2</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical2</span><span class="p">)</span>

    <span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangent_length2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dogleg2</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">min_dist_to_target</span><span class="p">(</span>
        <span class="n">radius_effective2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">distances2</span>
    <span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">dogleg2</span> <span class="o">=</span> <span class="n">check_dogleg</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dogleg2</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">dist_curve2</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">func_dogleg2</span> <span class="o">=</span> <span class="n">get_curve_hold_data</span><span class="p">(</span>
                <span class="n">radius_effective2</span><span class="p">,</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dogleg2</span>
            <span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vec2</span> <span class="o">=</span> <span class="n">get_vec_target</span><span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">vec_target</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangent_length2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dist_curve2</span><span class="p">,</span>
        <span class="n">c</span><span class="o">.</span><span class="n">func_dogleg2</span>
    <span class="p">)</span>

    <span class="n">tangent_temp2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_get_tangent_temp</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tangent_length2</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">pos3</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pos2</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">tangent_temp2</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">vec2</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">vec23_denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos3</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">pos2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vec23_denom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">vec23</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">vec23</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">pos3</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">pos2</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec23_denom</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">vec23</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">vec_old</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">rtol</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">min_error</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">min_error</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">pos3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos3</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">pos2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">md_target</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">md1</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">dist_curve</span> <span class="o">+</span> <span class="n">tangent_temp2</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">dist_curve2</span>
    <span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">delta_radius_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="nb">abs</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius_critical</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_critical2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">dls</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">dls_from_radius</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius_design</span><span class="p">),</span>
        <span class="n">dls_from_radius</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius_critical</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">dls2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">dls_from_radius</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius_design2</span><span class="p">),</span>
        <span class="n">dls_from_radius</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius_critical2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">radius_temp2</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_design2</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_design2</span> <span class="o">-</span> <span class="n">radius_temp2</span>
        <span class="k">if</span> <span class="n">radius_temp1</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_design</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">radius_design</span> <span class="o">-</span> <span class="n">radius_temp1</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">minimize_target_pos_and_vec_defined</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">pos3</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">vec23</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="check_dogleg"><a class="viewcode-back" href="../../welleng.html#welleng.connector.check_dogleg">[docs]</a><span class="k">def</span> <span class="nf">check_dogleg</span><span class="p">(</span><span class="n">dogleg</span><span class="p">):</span>
    <span class="c1"># the code assumes angles are positive and clockwise</span>
    <span class="k">if</span> <span class="n">dogleg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dogleg_new</span> <span class="o">=</span> <span class="n">dogleg</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">return</span> <span class="n">dogleg_new</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dogleg</span></div>


<div class="viewcode-block" id="mod_vec"><a class="viewcode-back" href="../../welleng.html#welleng.connector.mod_vec">[docs]</a><span class="k">def</span> <span class="nf">mod_vec</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="c1"># if it&#39;s not working then twat it with a hammer</span>
    <span class="n">vec_mod</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">error</span><span class="p">])</span>
    <span class="n">vec_mod</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec_mod</span><span class="p">)</span>
    <span class="n">inc_mod</span><span class="p">,</span> <span class="n">azi_mod</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="n">vec_mod</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">vec_mod</span><span class="p">,</span> <span class="n">inc_mod</span><span class="p">,</span> <span class="n">azi_mod</span></div>


<span class="k">def</span> <span class="nf">_get_xyz</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>


<div class="viewcode-block" id="get_pos"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_pos">[docs]</a><span class="k">def</span> <span class="nf">get_pos</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">dist_curve</span><span class="p">,</span> <span class="n">func_dogleg</span><span class="p">):</span>
    <span class="n">inc1</span><span class="p">,</span> <span class="n">azi1</span> <span class="o">=</span> <span class="n">_get_angles</span><span class="p">(</span><span class="n">_get_xyz</span><span class="p">(</span><span class="n">vec1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">inc2</span><span class="p">,</span> <span class="n">azi2</span> <span class="o">=</span> <span class="n">_get_angles</span><span class="p">(</span><span class="n">_get_xyz</span><span class="p">(</span><span class="n">vec2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">pos2</span> <span class="o">=</span> <span class="n">pos1</span> <span class="o">+</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">dist_curve</span> <span class="o">*</span> <span class="n">func_dogleg</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="o">*</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inc2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi2</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inc2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi2</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc2</span><span class="p">)</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pos2</span></div>


<div class="viewcode-block" id="get_vec_target"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_vec_target">[docs]</a><span class="k">def</span> <span class="nf">get_vec_target</span><span class="p">(</span>
    <span class="n">pos1</span><span class="p">,</span>
    <span class="n">vec1</span><span class="p">,</span>
    <span class="n">pos_target</span><span class="p">,</span>
    <span class="n">tangent_length</span><span class="p">,</span>
    <span class="n">dist_curve</span><span class="p">,</span>
    <span class="n">func_dogleg</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">dist_curve</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vec1</span>

    <span class="n">vec_target</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pos_target</span> <span class="o">-</span> <span class="n">pos1</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">dist_curve</span>
                    <span class="o">*</span> <span class="n">func_dogleg</span>
                <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vec1</span>
        <span class="p">)</span>
        <span class="o">/</span>
        <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">dist_curve</span> <span class="o">*</span> <span class="n">func_dogleg</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">tangent_length</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">vec_target</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec_target</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vec_target</span></div>


<div class="viewcode-block" id="get_curve_hold_data"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_curve_hold_data">[docs]</a><span class="k">def</span> <span class="nf">get_curve_hold_data</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">dogleg</span><span class="p">):</span>
    <span class="n">dist_curve</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">dogleg</span>
    <span class="n">func_dogleg</span> <span class="o">=</span> <span class="n">shape_factor</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">dist_curve</span><span class="p">,</span>
        <span class="n">func_dogleg</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="shape_factor"><a class="viewcode-back" href="../../welleng.html#welleng.connector.shape_factor">[docs]</a><span class="k">def</span> <span class="nf">shape_factor</span><span class="p">(</span><span class="n">dogleg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to determine the shape factor of a dogleg.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        dogleg: float</span>
<span class="sd">            The dogleg angle in radians of a curve section.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dogleg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">dogleg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dogleg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="min_dist_to_target"><a class="viewcode-back" href="../../welleng.html#welleng.connector.min_dist_to_target">[docs]</a><span class="k">def</span> <span class="nf">min_dist_to_target</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the control points for a curve and hold section from the</span>
<span class="sd">    start position and vector to the target position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">dist_to_target</span><span class="p">,</span>
        <span class="n">dist_perp_to_target</span><span class="p">,</span>
        <span class="n">dist_norm_to_target</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">distances</span>

    <span class="n">tangent_length</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dist_to_target</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">dist_norm_to_target</span>
    <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

    <span class="c1"># determine the dogleg angle of the curve section</span>
    <span class="n">dogleg</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="p">(</span><span class="n">dist_perp_to_target</span> <span class="o">-</span> <span class="n">tangent_length</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">dist_norm_to_target</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">tangent_length</span><span class="p">,</span> <span class="n">dogleg</span></div>


<div class="viewcode-block" id="min_curve_to_target"><a class="viewcode-back" href="../../welleng.html#welleng.connector.min_curve_to_target">[docs]</a><span class="k">def</span> <span class="nf">min_curve_to_target</span><span class="p">(</span><span class="n">distances</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the control points for a curve section from the start</span>
<span class="sd">    position and vector to the target position which is not achievable with</span>
<span class="sd">    the provided dls_design.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">distances</span> <span class="o">==</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="mf">0.</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="mf">0.</span>
        <span class="p">)</span>

    <span class="p">(</span>
        <span class="n">dist_to_target</span><span class="p">,</span>
        <span class="n">dist_perp_to_target</span><span class="p">,</span>
        <span class="n">dist_norm_to_target</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">distances</span>

    <span class="k">if</span> <span class="n">dist_norm_to_target</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">radius_critical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">radius_critical</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dist_to_target</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">dist_norm_to_target</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">assert</span> <span class="n">radius_critical</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">dogleg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
            <span class="n">dist_norm_to_target</span><span class="p">,</span>
            <span class="n">dist_perp_to_target</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">tangent_length</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">tangent_length</span><span class="p">,</span>
        <span class="n">radius_critical</span><span class="p">,</span>
        <span class="n">dogleg</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_radius_critical"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_radius_critical">[docs]</a><span class="k">def</span> <span class="nf">get_radius_critical</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">min_error</span><span class="p">):</span>
    <span class="p">(</span>
        <span class="n">dist_to_target</span><span class="p">,</span>
        <span class="n">dist_perp_to_target</span><span class="p">,</span>
        <span class="n">dist_norm_to_target</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">distances</span>

    <span class="k">if</span> <span class="n">dist_norm_to_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">radius_critical</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dist_to_target</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">dist_norm_to_target</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_error</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">radius_critical</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">radius_critical</span></div>


<div class="viewcode-block" id="angle"><a class="viewcode-back" href="../../welleng.html#welleng.connector.angle">[docs]</a><span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">acute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span>
        <span class="o">/</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec2</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">acute</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">angle</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="get_dogleg"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_dogleg">[docs]</a><span class="k">def</span> <span class="nf">get_dogleg</span><span class="p">(</span><span class="n">inc1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">inc2</span><span class="p">,</span> <span class="n">azi2</span><span class="p">):</span>
    <span class="n">dogleg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">inc2</span> <span class="o">-</span> <span class="n">inc1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inc1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inc2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">azi2</span> <span class="o">-</span> <span class="n">azi1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">dogleg</span></div>


<div class="viewcode-block" id="interpolate_well"><a class="viewcode-back" href="../../welleng.html#welleng.connector.interpolate_well">[docs]</a><span class="k">def</span> <span class="nf">interpolate_well</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a well survey from a list of sections of control points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sections: list of welleng.connector.Connector objects</span>
<span class="sd">    step: float (default: 30)</span>
<span class="sd">        The desired delta measured depth between survey points, in</span>
<span class="sd">        addition to the control points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data: list of welleng.connector.Connector objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;hold&#39;</span><span class="p">:</span> <span class="n">get_interpolate_hold</span><span class="p">,</span>
        <span class="s1">&#39;min_dist_to_target&#39;</span><span class="p">:</span> <span class="n">get_interpolate_min_dist_to_target</span><span class="p">,</span>
        <span class="s1">&#39;min_curve_to_target&#39;</span><span class="p">:</span> <span class="n">get_interpolate_min_curve_to_target</span><span class="p">,</span>
        <span class="s1">&#39;curve_hold_curve&#39;</span><span class="p">:</span> <span class="n">get_interpololate_curve_hold_curve</span><span class="p">,</span>
        <span class="s1">&#39;min_curve&#39;</span><span class="p">:</span> <span class="n">get_min_curve</span>
    <span class="p">}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">sections</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">method</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">method</span><span class="p">](</span><span class="n">s</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="interpolate_curve"><a class="viewcode-back" href="../../welleng.html#welleng.connector.interpolate_curve">[docs]</a><span class="k">def</span> <span class="nf">interpolate_curve</span><span class="p">(</span>
    <span class="n">md1</span><span class="p">,</span>
    <span class="n">pos1</span><span class="p">,</span>
    <span class="n">vec1</span><span class="p">,</span>
    <span class="n">vec2</span><span class="p">,</span>
    <span class="n">dist_curve</span><span class="p">,</span>
    <span class="n">dogleg</span><span class="p">,</span>
    <span class="n">func_dogleg</span><span class="p">,</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="c1"># sometimes the curve section has no length</span>
    <span class="c1"># this if statement handles this event</span>
    <span class="k">if</span> <span class="n">dist_curve</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">md</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">md1</span><span class="p">]),</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vec1</span><span class="p">]),</span>
            <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
            <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
            <span class="n">dogleg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dogleg</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="n">end_md</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dist_curve</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_md</span> <span class="o">=</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">md1</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_md</span><span class="p">,</span> <span class="n">end_md</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mf">0.</span><span class="p">],</span> <span class="n">md</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">md</span><span class="p">,</span> <span class="p">[</span><span class="n">end_md</span><span class="p">]))</span>
    <span class="n">dogleg_interp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dogleg</span> <span class="o">/</span> <span class="n">dist_curve</span> <span class="o">*</span> <span class="n">md</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span> <span class="o">-</span> <span class="n">dogleg_interp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span> <span class="o">*</span> <span class="n">vec1</span>
        <span class="p">)</span>
        <span class="o">+</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg_interp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dogleg</span><span class="p">)</span> <span class="o">*</span> <span class="n">vec2</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span> <span class="o">+</span> <span class="n">md1</span><span class="p">,</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">dogleg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dogleg_interp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">)),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="interpolate_hold"><a class="viewcode-back" href="../../welleng.html#welleng.connector.interpolate_hold">[docs]</a><span class="k">def</span> <span class="nf">interpolate_hold</span><span class="p">(</span><span class="n">md1</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">md2</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">end_md</span> <span class="o">=</span> <span class="n">md2</span> <span class="o">-</span> <span class="n">md1</span>
    <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_md</span> <span class="o">=</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">md1</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_md</span><span class="p">,</span> <span class="n">end_md</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mf">0.</span><span class="p">],</span> <span class="n">md</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">md</span><span class="p">,</span> <span class="p">[</span><span class="n">end_md</span><span class="p">]))</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">md</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">vec1</span><span class="p">)</span>
    <span class="n">inc</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">dogleg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md</span> <span class="o">+</span> <span class="n">md1</span><span class="p">,</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span>
        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">azi</span><span class="o">=</span><span class="n">azi</span><span class="p">,</span>
        <span class="n">dogleg</span><span class="o">=</span><span class="n">dogleg</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_min_curve"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_min_curve">[docs]</a><span class="k">def</span> <span class="nf">get_min_curve</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">md2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">get_interpolate_min_curve_to_target</span><span class="p">(</span>
                <span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">data</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">get_interpolate_min_dist_to_target</span><span class="p">(</span>
                <span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">data</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_interpolate_hold"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_interpolate_hold">[docs]</a><span class="k">def</span> <span class="nf">get_interpolate_hold</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_hold</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md1</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
        <span class="n">md2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md_target</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_interpolate_min_curve_to_target"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_interpolate_min_curve_to_target">[docs]</a><span class="k">def</span> <span class="nf">get_interpolate_min_curve_to_target</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_curve</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md1</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
        <span class="n">vec2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
        <span class="n">dist_curve</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
        <span class="n">dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dogleg</span><span class="p">,</span>
        <span class="n">func_dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">func_dogleg</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_interpolate_min_dist_to_target"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_interpolate_min_dist_to_target">[docs]</a><span class="k">def</span> <span class="nf">get_interpolate_min_dist_to_target</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># the first curve section</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_curve</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md1</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
        <span class="n">vec2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span>
        <span class="n">dist_curve</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
        <span class="n">dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dogleg</span><span class="p">,</span>
        <span class="n">func_dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">func_dogleg</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span>
    <span class="p">))</span>

    <span class="c1"># the hold section</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_hold</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md2</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos2</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span>
        <span class="n">md2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md_target</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_interpololate_curve_hold_curve"><a class="viewcode-back" href="../../welleng.html#welleng.connector.get_interpololate_curve_hold_curve">[docs]</a><span class="k">def</span> <span class="nf">get_interpololate_curve_hold_curve</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># the first curve section</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_curve</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md1</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec1</span><span class="p">,</span>
        <span class="n">vec2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span>
        <span class="n">dist_curve</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dist_curve</span><span class="p">,</span>
        <span class="n">dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dogleg</span><span class="p">,</span>
        <span class="n">func_dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">func_dogleg</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span>
    <span class="p">))</span>

    <span class="c1"># the hold section</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_hold</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md2</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos2</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span>
        <span class="n">md2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md3</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span>
    <span class="p">))</span>

    <span class="c1"># the second curve section</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate_curve</span><span class="p">(</span>
        <span class="n">md1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">md3</span><span class="p">,</span>
        <span class="n">pos1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">pos3</span><span class="p">,</span>
        <span class="n">vec1</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span>
        <span class="n">vec2</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">vec_target</span><span class="p">,</span>
        <span class="n">dist_curve</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dist_curve2</span><span class="p">,</span>
        <span class="n">dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">dogleg2</span><span class="p">,</span>
        <span class="n">func_dogleg</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">func_dogleg2</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="convert_target_input_to_booleans"><a class="viewcode-back" href="../../welleng.html#welleng.connector.convert_target_input_to_booleans">[docs]</a><span class="k">def</span> <span class="nf">convert_target_input_to_booleans</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;0&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;1&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inputs</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span></div>


<div class="viewcode-block" id="connect_points"><a class="viewcode-back" href="../../welleng.html#welleng.connector.connect_points">[docs]</a><span class="k">def</span> <span class="nf">connect_points</span><span class="p">(</span>
    <span class="n">cartesians</span><span class="p">,</span> <span class="n">vec_start</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">dls_design</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">nev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># step=30,</span>
    <span class="n">md_start</span><span class="o">=</span><span class="mf">0.</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for connecting a list or array of only Cartesian points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        cartesians: (n, 3) list or array of floats</span>
<span class="sd">            Either [n, e, tvd] (default) or [x, y, z]</span>
<span class="sd">        vec_start: (3) list or array of floats (default: [0., 0., 1.])</span>
<span class="sd">            Unit start vector (default is pointing down) in the nev or xyz</span>
<span class="sd">            coordinate system.</span>
<span class="sd">        dls_design: float or (n, 1) list or array of floats (default: 3.0)</span>
<span class="sd">            The minimum Dog Leg Severity used when attempting to connect the</span>
<span class="sd">            points (a high DLS will be used if necessary).</span>
<span class="sd">        nev: bool (default: True)</span>
<span class="sd">            Indicates whether the cartesians are referencing the [nev]</span>
<span class="sd">            (default) or [xyz] coordinate system.</span>
<span class="sd">        step: float (default: 30)</span>
<span class="sd">            The desired step interval for the returned Survey object.</span>
<span class="sd">        md_start: float (default: 0)</span>
<span class="sd">            The md at the first cartesian point (in the event of a tie-on).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        data: list of welleng.connector.Connector objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nev</span><span class="p">:</span>
        <span class="n">pos_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cartesians</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vec_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_nev</span><span class="p">)</span>
        <span class="n">vec_nev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec_start</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tvd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cartesians</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">pos_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">vec_nev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_nev</span><span class="p">)</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tvd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec_start</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">vec_nev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tvd</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dls_design</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">dls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_nev</span><span class="p">),</span> <span class="n">dls_design</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dls_design</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pos_nev</span><span class="p">,</span> <span class="n">vec_nev</span><span class="p">,</span> <span class="n">dls</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">node_1</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                <span class="n">vec</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
                <span class="n">md</span><span class="o">=</span><span class="n">md_start</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">node_1</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">node_end</span>
        <span class="n">node_2</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">(</span>
            <span class="n">node1</span><span class="o">=</span><span class="n">node_1</span><span class="p">,</span>
            <span class="n">node2</span><span class="o">=</span><span class="n">node_2</span><span class="p">,</span>
            <span class="n">dls_design</span><span class="o">=</span><span class="n">d</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos_target</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">connections</span></div>


<div class="viewcode-block" id="survey_to_plan"><a class="viewcode-back" href="../../welleng.html#welleng.connector.survey_to_plan">[docs]</a><span class="k">def</span> <span class="nf">survey_to_plan</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">dls_design</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">30.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prototype function for extracting a plan from a drilled well survey - a</span>
<span class="sd">    minimal number of control points (begining/end points of either hold or</span>
<span class="sd">    build/turn sections) required to express the well given the provided input</span>
<span class="sd">    parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survey: welleng.survey.Survey object</span>
<span class="sd">    tolerance: float (default=0.2)</span>
<span class="sd">        Defines how tight to fit the planned well to the survey - a higher</span>
<span class="sd">        number will results in less control points but likely poorer fit.</span>
<span class="sd">    dls_design: float (default=1.0)</span>
<span class="sd">        The minimum DLS used to fit the planned trajectory.</span>
<span class="sd">    step: float (default=30)</span>
<span class="sd">        The desired md step in the plan survey.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sections: list of welleng.connector.Connection objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dls_design</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">&quot;dls_design must be greater than 0&quot;</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">section</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">_get_section</span><span class="p">(</span>
            <span class="n">survey</span><span class="o">=</span><span class="n">survey</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
            <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="n">dls_design</span><span class="o">=</span><span class="n">dls_design</span>
        <span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">node_end</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">interpolate_well</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sections</span></div>


<span class="k">def</span> <span class="nf">_get_section</span><span class="p">(</span>
    <span class="n">survey</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">dls_design</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">nev</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_nev_arr</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nev</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node_1</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">nev</span><span class="p">[</span><span class="n">start</span><span class="p">],</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="n">start</span><span class="p">],</span>
            <span class="n">md</span><span class="o">=</span><span class="n">md</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node_1</span> <span class="o">=</span> <span class="n">node</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
    <span class="n">delta_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c_old</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nev</span><span class="p">[</span><span class="n">idx</span><span class="p">:],</span> <span class="n">survey</span><span class="o">.</span><span class="n">vec_nev</span><span class="p">[</span><span class="n">idx</span><span class="p">:])):</span>
        <span class="n">node_2</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">(</span>
            <span class="n">node1</span><span class="o">=</span><span class="n">node_1</span><span class="p">,</span>
            <span class="n">node2</span><span class="o">=</span><span class="n">node_2</span><span class="p">,</span>
            <span class="n">dls_design</span><span class="o">=</span><span class="n">dls_design</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">survey</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c_old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_old</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">nev_new</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_nev_arr</span><span class="p">()</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span>
            <span class="n">nev</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span>
            <span class="n">nev_new</span>
        <span class="p">)</span>

        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">delta_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span> <span class="o">-</span> <span class="n">scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">((</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">delta_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">tolerance</span><span class="p">,</span>
            <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="p">)):</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">c_old</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_old</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">c_old</span><span class="p">,</span>
        <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span>
    <span class="p">)</span>


<div class="viewcode-block" id="numbafy"><a class="viewcode-back" href="../../welleng.html#welleng.connector.numbafy">[docs]</a><span class="k">def</span> <span class="nf">numbafy</span><span class="p">(</span><span class="n">functions</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">njit</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<span class="k">if</span> <span class="n">NUMBA</span><span class="p">:</span>
    <span class="n">NUMBAFY</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_get_xyz</span><span class="p">,</span>
        <span class="n">get_pos</span><span class="p">,</span>
        <span class="n">get_vec_target</span><span class="p">,</span>
        <span class="n">get_curve_hold_data</span><span class="p">,</span>
        <span class="n">shape_factor</span><span class="p">,</span>
        <span class="n">min_dist_to_target</span><span class="p">,</span>
        <span class="n">get_radius_critical</span><span class="p">,</span>
        <span class="n">angle</span><span class="p">,</span>
        <span class="n">get_dogleg</span>
    <span class="p">)</span>
    <span class="n">numbafy</span><span class="p">(</span><span class="n">NUMBAFY</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Jonny Corcutt.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-186225449-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-186225449-3', {
          'anonymize_ip': false,
      });
    </script>
    <!-- your html code here -->


</body>
</html>